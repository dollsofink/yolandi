import{_ as L,bC as me,bw as E,J as N,N as _,aB as m,aI as Z,O as C,M as j,Y as V,L as F,F as q,aH as ne,bG as A,b7 as Ve,a as kn,bL as he,p as K,bJ as X,bq as de,bM as U,b9 as ve,n as ke,w as Te,bo as Ot,by as In,bu as ae,b2 as ue,ah as At,av as ze,aA as Pt,ar as nt,ao as ot,aJ as ge,o as Rt,T as st,aL as it,W as Ge,bz as Mn,bE as pe,bD as Nn,bg as En,bj as Tn,br as $n,X as Sn,aD as Dt}from"./runtime-dom.esm-bundler-_dOoQjef.js";const z=[];for(let t=0;t<256;++t)z.push((t+256).toString(16).slice(1));function On(t,e=0){return(z[t[e+0]]+z[t[e+1]]+z[t[e+2]]+z[t[e+3]]+"-"+z[t[e+4]]+z[t[e+5]]+"-"+z[t[e+6]]+z[t[e+7]]+"-"+z[t[e+8]]+z[t[e+9]]+"-"+z[t[e+10]]+z[t[e+11]]+z[t[e+12]]+z[t[e+13]]+z[t[e+14]]+z[t[e+15]]).toLowerCase()}let Ke;const An=new Uint8Array(16);function Pn(){if(!Ke){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ke=crypto.getRandomValues.bind(crypto)}return Ke(An)}const Rn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),_t={randomUUID:Rn};function le(t,e,n){if(_t.randomUUID&&!t)return _t.randomUUID();t=t||{};const o=t.random??t.rng?.()??Pn();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,On(o)}class fe{constructor(){this.listenerMap=new Map,this._listeners=[],this.proxyMap=new Map,this.proxies=[]}get listeners(){return this._listeners.concat(this.proxies.flatMap(e=>e()))}subscribe(e,n){this.listenerMap.has(e)&&(console.warn(`Already subscribed. Unsubscribing for you.
Please check that you don't accidentally use the same token twice to register two different handlers for the same event/hook.`),this.unsubscribe(e)),this.listenerMap.set(e,n),this._listeners.push(n)}unsubscribe(e){if(this.listenerMap.has(e)){const n=this.listenerMap.get(e);this.listenerMap.delete(e);const o=this._listeners.indexOf(n);o>=0&&this._listeners.splice(o,1)}}registerProxy(e,n){this.proxyMap.has(e)&&(console.warn(`Already subscribed. Unsubscribing for you.
Please check that you don't accidentally use the same token twice to register two different proxies for the same event/hook.`),this.unregisterProxy(e)),this.proxyMap.set(e,n),this.proxies.push(n)}unregisterProxy(e){if(!this.proxyMap.has(e))return;const n=this.proxyMap.get(e);this.proxyMap.delete(e);const o=this.proxies.indexOf(n);o>=0&&this.proxies.splice(o,1)}}class H extends fe{constructor(e){super(),this.entity=e}emit(e){this.listeners.forEach(n=>n(e,this.entity))}}class Y extends fe{constructor(e){super(),this.entity=e}emit(e){let n=!1;const o=()=>[n=!0];for(const s of Array.from(this.listeners.values()))if(s(e,o,this.entity),n)return{prevented:!0};return{prevented:!1}}}class Dn extends fe{execute(e,n){let o=e;for(const s of this.listeners)o=s(o,n);return o}}class te extends Dn{constructor(e){super(),this.entity=e}execute(e){return super.execute(e,this.entity)}}class Bn extends fe{constructor(e){super(),this.entity=e}execute(e){const n=[];for(const o of this.listeners)n.push(o(e,this.entity));return n}}function ie(){const t=Symbol(),e=new Map,n=new Set,o=(l,u)=>{u instanceof fe&&u.registerProxy(t,()=>{var h,v;return(v=(h=e.get(l))===null||h===void 0?void 0:h.listeners)!==null&&v!==void 0?v:[]})},s=l=>{const u=new fe;e.set(l,u),n.forEach(h=>o(l,h[l]))},r=l=>{n.add(l);for(const u of e.keys())o(u,l[u])},i=l=>{for(const u of e.keys())l[u]instanceof fe&&l[u].unregisterProxy(t);n.delete(l)},a=()=>{n.forEach(l=>i(l)),e.clear()};return new Proxy({},{get(l,u){return u==="addTarget"?r:u==="removeTarget"?i:u==="destroy"?a:typeof u!="string"||u.startsWith("_")?l[u]:(e.has(u)||s(u),e.get(u))}})}class Ct{constructor(e,n){if(this.destructed=!1,this.events={destruct:new H(this)},!e||!n)throw new Error("Cannot initialize connection with null/undefined for 'from' or 'to' values");this.id=le(),this.from=e,this.to=n,this.from.connectionCount++,this.to.connectionCount++}destruct(){this.events.destruct.emit(),this.from.connectionCount--,this.to.connectionCount--,this.destructed=!0}}class Hn{constructor(e,n){if(!e||!n)throw new Error("Cannot initialize connection with null/undefined for 'from' or 'to' values");this.id=le(),this.from=e,this.to=n}}function Qe(t,e){return Object.fromEntries(Object.entries(t).map(([n,o])=>[n,e(o)]))}class Bt{constructor(){this._title="",this.id=le(),this.events={loaded:new H(this),beforeAddInput:new Y(this),addInput:new H(this),beforeRemoveInput:new Y(this),removeInput:new H(this),beforeAddOutput:new Y(this),addOutput:new H(this),beforeRemoveOutput:new Y(this),removeOutput:new H(this),beforeTitleChanged:new Y(this),titleChanged:new H(this),update:new H(this)},this.hooks={beforeLoad:new te(this),afterSave:new te(this)}}get graph(){return this.graphInstance}get title(){return this._title}set title(e){this.events.beforeTitleChanged.emit(e).prevented||(this._title=e,this.events.titleChanged.emit(e))}addInput(e,n){return this.addInterface("input",e,n)}addOutput(e,n){return this.addInterface("output",e,n)}removeInput(e){return this.removeInterface("input",e)}removeOutput(e){return this.removeInterface("output",e)}registerGraph(e){this.graphInstance=e}load(e){this.hooks.beforeLoad.execute(e),this.id=e.id,this._title=e.title,Object.entries(e.inputs).forEach(([n,o])=>{this.inputs[n]&&(this.inputs[n].load(o),this.inputs[n].nodeId=this.id)}),Object.entries(e.outputs).forEach(([n,o])=>{this.outputs[n]&&(this.outputs[n].load(o),this.outputs[n].nodeId=this.id)}),this.events.loaded.emit(this)}save(){const e=Qe(this.inputs,s=>s.save()),n=Qe(this.outputs,s=>s.save()),o={type:this.type,id:this.id,title:this.title,inputs:e,outputs:n};return this.hooks.afterSave.execute(o)}onPlaced(){}onDestroy(){}initializeIo(){Object.entries(this.inputs).forEach(([e,n])=>this.initializeIntf("input",e,n)),Object.entries(this.outputs).forEach(([e,n])=>this.initializeIntf("output",e,n))}initializeIntf(e,n,o){o.isInput=e==="input",o.nodeId=this.id,o.events.setValue.subscribe(this,()=>this.events.update.emit({type:e,name:n,intf:o}))}addInterface(e,n,o){const s=e==="input"?this.events.beforeAddInput:this.events.beforeAddOutput,r=e==="input"?this.events.addInput:this.events.addOutput,i=e==="input"?this.inputs:this.outputs;return s.emit(o).prevented?!1:(i[n]=o,this.initializeIntf(e,n,o),r.emit(o),!0)}removeInterface(e,n){const o=e==="input"?this.events.beforeRemoveInput:this.events.beforeRemoveOutput,s=e==="input"?this.events.removeInput:this.events.removeOutput,r=e==="input"?this.inputs[n]:this.outputs[n];if(!r||o.emit(r).prevented)return!1;if(r.connectionCount>0)if(this.graphInstance)this.graphInstance.connections.filter(a=>a.from===r||a.to===r).forEach(a=>{this.graphInstance.removeConnection(a)});else throw new Error("Interface is connected, but no graph instance is specified. Unable to delete interface");return r.events.setValue.unsubscribe(this),e==="input"?delete this.inputs[n]:delete this.outputs[n],s.emit(r),!0}}class Ln extends Bt{load(e){super.load(e)}save(){return super.save()}}class W{set connectionCount(e){this._connectionCount=e,this.events.setConnectionCount.emit(e)}get connectionCount(){return this._connectionCount}set value(e){this.events.beforeSetValue.emit(e).prevented||(this._value=e,this.events.setValue.emit(e))}get value(){return this._value}constructor(e,n){this.id=le(),this.nodeId="",this.port=!0,this.hidden=!1,this.events={setConnectionCount:new H(this),beforeSetValue:new Y(this),setValue:new H(this),updated:new H(this)},this.hooks={load:new te(this),save:new te(this)},this._connectionCount=0,this.name=e,this._value=n}load(e){this.id=e.id,this.templateId=e.templateId,this.value=e.value,this.hooks.load.execute(e)}save(){const e={id:this.id,templateId:this.templateId,value:this.value};return this.hooks.save.execute(e)}setComponent(e){return this.component=e,this}setPort(e){return this.port=e,this}setHidden(e){return this.hidden=e,this}use(e,...n){return e(this,...n),this}}const we="__baklava_SubgraphInputNode",_e="__baklava_SubgraphOutputNode";class Ht extends Ln{constructor(){super(),this.graphInterfaceId=le()}onPlaced(){super.onPlaced(),this.initializeIo()}save(){return{...super.save(),graphInterfaceId:this.graphInterfaceId}}load(e){super.load(e),this.graphInterfaceId=e.graphInterfaceId}}class at extends Ht{constructor(){super(...arguments),this.type=we,this.inputs={name:new W("Name","Input")},this.outputs={placeholder:new W("Value",void 0)}}static isGraphInputNode(e){return e.type===we}}class rt extends Ht{constructor(){super(...arguments),this.type=_e,this.inputs={name:new W("Name","Output"),placeholder:new W("Value",void 0)},this.outputs={output:new W("Output",void 0).setHidden(!0)},this.calculate=({placeholder:e})=>({output:e})}static isGraphOutputNode(e){return e.type===_e}}class je{get nodes(){return this._nodes}get connections(){return this._connections}get loading(){return this._loading}get destroying(){return this._destroying}get inputs(){return this.nodes.filter(n=>n.type===we).map(n=>({id:n.graphInterfaceId,name:n.inputs.name.value,nodeId:n.id,nodeInterfaceId:n.outputs.placeholder.id}))}get outputs(){return this.nodes.filter(n=>n.type===_e).map(n=>({id:n.graphInterfaceId,name:n.inputs.name.value,nodeId:n.id,nodeInterfaceId:n.outputs.output.id}))}constructor(e,n){this.id=le(),this.activeTransactions=0,this._nodes=[],this._connections=[],this._loading=!1,this._destroying=!1,this.events={beforeAddNode:new Y(this),addNode:new H(this),beforeRemoveNode:new Y(this),removeNode:new H(this),beforeAddConnection:new Y(this),addConnection:new H(this),checkConnection:new Y(this),beforeRemoveConnection:new Y(this),removeConnection:new H(this)},this.hooks={save:new te(this),load:new te(this),checkConnection:new Bn(this)},this.nodeEvents=ie(),this.nodeHooks=ie(),this.connectionEvents=ie(),this.editor=e,this.template=n,e.registerGraph(this)}addNode(e){if(!this.events.beforeAddNode.emit(e).prevented)return this.nodeEvents.addTarget(e.events),this.nodeHooks.addTarget(e.hooks),e.registerGraph(this),this._nodes.push(e),e=this.nodes.find(n=>n.id===e.id),e.onPlaced(),this.events.addNode.emit(e),e}removeNode(e){if(this.nodes.includes(e)){if(this.events.beforeRemoveNode.emit(e).prevented)return;const n=[...Object.values(e.inputs),...Object.values(e.outputs)];this.connections.filter(o=>n.includes(o.from)||n.includes(o.to)).forEach(o=>this.removeConnection(o)),this._nodes.splice(this.nodes.indexOf(e),1),this.events.removeNode.emit(e),e.onDestroy(),this.nodeEvents.removeTarget(e.events),this.nodeHooks.removeTarget(e.hooks)}}addConnection(e,n){const o=this.checkConnection(e,n);if(!o.connectionAllowed||this.events.beforeAddConnection.emit({from:e,to:n}).prevented)return;for(const r of o.connectionsInDanger){const i=this.connections.find(a=>a.id===r.id);i&&this.removeConnection(i)}const s=new Ct(o.dummyConnection.from,o.dummyConnection.to);return this.internalAddConnection(s),s}removeConnection(e){if(this.connections.includes(e)){if(this.events.beforeRemoveConnection.emit(e).prevented)return;e.destruct(),this._connections.splice(this.connections.indexOf(e),1),this.events.removeConnection.emit(e),this.connectionEvents.removeTarget(e.events)}}checkConnection(e,n){if(!e||!n)return{connectionAllowed:!1};const o=this.findNodeById(e.nodeId),s=this.findNodeById(n.nodeId);if(o&&s&&o===s)return{connectionAllowed:!1};if(e.isInput&&!n.isInput){const a=e;e=n,n=a}if(e.isInput||!n.isInput)return{connectionAllowed:!1};if(this.connections.some(a=>a.from===e&&a.to===n))return{connectionAllowed:!1};if(this.events.checkConnection.emit({from:e,to:n}).prevented)return{connectionAllowed:!1};const r=this.hooks.checkConnection.execute({from:e,to:n});if(r.some(a=>!a.connectionAllowed))return{connectionAllowed:!1};const i=Array.from(new Set(r.flatMap(a=>a.connectionsInDanger)));return{connectionAllowed:!0,dummyConnection:new Hn(e,n),connectionsInDanger:i}}findNodeInterface(e){for(const n of this.nodes){for(const o in n.inputs){const s=n.inputs[o];if(s.id===e)return s}for(const o in n.outputs){const s=n.outputs[o];if(s.id===e)return s}}}findNodeById(e){return this.nodes.find(n=>n.id===e)}load(e){try{this._loading=!0;const n=[];for(let o=this.connections.length-1;o>=0;o--)this.removeConnection(this.connections[o]);for(let o=this.nodes.length-1;o>=0;o--)this.removeNode(this.nodes[o]);this.id=e.id;for(const o of e.nodes){const s=this.editor.nodeTypes.get(o.type);if(!s){n.push(`Node type ${o.type} is not registered`);continue}const r=new s.type;this.addNode(r),r.load(o)}for(const o of e.connections){const s=this.findNodeInterface(o.from),r=this.findNodeInterface(o.to);if(s)if(r){const i=new Ct(s,r);i.id=o.id,this.internalAddConnection(i)}else{n.push(`Could not find interface with id ${o.to}`);continue}else{n.push(`Could not find interface with id ${o.from}`);continue}}return this.hooks.load.execute(e),n}finally{this._loading=!1}}save(){const e={id:this.id,nodes:this.nodes.map(n=>n.save()),connections:this.connections.map(n=>({id:n.id,from:n.from.id,to:n.to.id})),inputs:this.inputs,outputs:this.outputs};return this.hooks.save.execute(e)}destroy(){this._destroying=!0;for(const e of this.nodes)this.removeNode(e);this.editor.unregisterGraph(this)}internalAddConnection(e){this.connectionEvents.addTarget(e.events),this._connections.push(e),this.events.addConnection.emit(e)}}const $e="__baklava_GraphNode-";function Ce(t){return $e+t.id}const Un=["component","connectionCount","events","hidden","hooks","id","isInput","name","nodeId","port","templateId","value"];function Vn(t){return class extends Bt{constructor(){super(...arguments),this.type=Ce(t),this.inputs={},this.outputs={},this.template=t,this.calculate=async(n,o)=>{var s;if(!this.subgraph)throw new Error(`GraphNode ${this.id}: calculate called without subgraph being initialized`);if(!o.engine||typeof o.engine!="object")throw new Error(`GraphNode ${this.id}: calculate called but no engine provided in context`);const r=o.engine.getInputValues(this.subgraph);for(const l of this.subgraph.inputs)r.set(l.nodeInterfaceId,n[l.id]);const i=await o.engine.runGraph(this.subgraph,r,o.globalValues),a={};for(const l of this.subgraph.outputs)a[l.id]=(s=i.get(l.nodeId))===null||s===void 0?void 0:s.get("output");return a._calculationResults=i,a}}get title(){return this._title}set title(n){this.template.name=n}load(n){if(!this.subgraph)throw new Error("Cannot load a graph node without a graph");if(!this.template)throw new Error("Unable to load graph node without graph template");this.subgraph.load(n.graphState),super.load(n)}save(){if(!this.subgraph)throw new Error("Cannot save a graph node without a graph");return{...super.save(),graphState:this.subgraph.save()}}onPlaced(){this.template.events.updated.subscribe(this,()=>this.initialize()),this.template.events.nameChanged.subscribe(this,n=>{this._title=n}),this.initialize()}onDestroy(){var n;this.template.events.updated.unsubscribe(this),this.template.events.nameChanged.unsubscribe(this),(n=this.subgraph)===null||n===void 0||n.destroy()}initialize(){this.subgraph&&this.subgraph.destroy(),this.subgraph=this.template.createGraph(),this._title=this.template.name,this.updateInterfaces(),this.events.update.emit(null)}updateInterfaces(){if(!this.subgraph)throw new Error("Trying to update interfaces without graph instance");for(const n of this.subgraph.inputs)n.id in this.inputs?this.inputs[n.id].name=n.name:this.addInput(n.id,this.createProxyInterface(n,!0));for(const n of Object.keys(this.inputs))this.subgraph.inputs.some(o=>o.id===n)||this.removeInput(n);for(const n of this.subgraph.outputs)n.id in this.outputs?this.outputs[n.id].name=n.name:this.addOutput(n.id,this.createProxyInterface(n,!1));for(const n of Object.keys(this.outputs))this.subgraph.outputs.some(o=>o.id===n)||this.removeOutput(n);this.addOutput("_calculationResults",new W("_calculationResults",void 0).setHidden(!0))}createProxyInterface(n,o){const s=new W(n.name,void 0);return new Proxy(s,{get:(r,i)=>{var a,l,u;if(Un.includes(i)||i in r||typeof i=="string"&&i.startsWith("__v_"))return Reflect.get(r,i);let h;if(o){const c=(a=this.subgraph)===null||a===void 0?void 0:a.nodes.find(d=>at.isGraphInputNode(d)&&d.graphInterfaceId===n.id);h=c?.outputs.placeholder.id}else{const c=(l=this.subgraph)===null||l===void 0?void 0:l.nodes.find(d=>rt.isGraphOutputNode(d)&&d.graphInterfaceId===n.id);h=c?.inputs.placeholder.id}const v=(u=this.subgraph)===null||u===void 0?void 0:u.connections.find(c=>{var d;return h===((d=o?c.from:c.to)===null||d===void 0?void 0:d.id)}),p=o?v?.to:v?.from;if(p)return Reflect.get(p,i)}})}}}class We{static fromGraph(e,n){return new We(e.save(),n)}get name(){return this._name}set name(e){this._name=e,this.events.nameChanged.emit(e);const n=this.editor.nodeTypes.get(Ce(this));n&&(n.title=e)}get inputs(){return this.nodes.filter(n=>n.type===we).map(n=>({id:n.graphInterfaceId,name:n.inputs.name.value,nodeId:n.id,nodeInterfaceId:n.outputs.placeholder.id}))}get outputs(){return this.nodes.filter(n=>n.type===_e).map(n=>({id:n.graphInterfaceId,name:n.inputs.name.value,nodeId:n.id,nodeInterfaceId:n.outputs.output.id}))}constructor(e,n){this.id=le(),this._name="Subgraph",this.events={nameChanged:new H(this),updated:new H(this)},this.hooks={beforeLoad:new te(this),afterSave:new te(this)},this.editor=n,e.id&&(this.id=e.id),e.name&&(this._name=e.name),this.update(e)}update(e){this.nodes=e.nodes,this.connections=e.connections,this.events.updated.emit()}save(){return{id:this.id,name:this.name,nodes:this.nodes,connections:this.connections,inputs:this.inputs,outputs:this.outputs}}createGraph(e){const n=new Map,o=p=>{const c=le();return n.set(p,c),c},s=p=>{const c=n.get(p);if(!c)throw new Error(`Unable to create graph from template: Could not map old id ${p} to new id`);return c},r=p=>Qe(p,c=>({id:o(c.id),templateId:c.id,value:c.value})),i=this.nodes.map(p=>({...p,id:o(p.id),inputs:r(p.inputs),outputs:r(p.outputs)})),a=this.connections.map(p=>({id:o(p.id),from:s(p.from),to:s(p.to)})),l=this.inputs.map(p=>({id:p.id,name:p.name,nodeId:s(p.nodeId),nodeInterfaceId:s(p.nodeInterfaceId)})),u=this.outputs.map(p=>({id:p.id,name:p.name,nodeId:s(p.nodeId),nodeInterfaceId:s(p.nodeInterfaceId)})),h={id:le(),nodes:i,connections:a,inputs:l,outputs:u};return e||(e=new je(this.editor)),e.load(h).forEach(p=>console.warn(p)),e.template=this,e}}class zn{get nodeTypes(){return this._nodeTypes}get graph(){return this._graph}get graphTemplates(){return this._graphTemplates}get graphs(){return this._graphs}get loading(){return this._loading}constructor(){this.events={loaded:new H(this),beforeRegisterNodeType:new Y(this),registerNodeType:new H(this),beforeUnregisterNodeType:new Y(this),unregisterNodeType:new H(this),beforeAddGraphTemplate:new Y(this),addGraphTemplate:new H(this),beforeRemoveGraphTemplate:new Y(this),removeGraphTemplate:new H(this),registerGraph:new H(this),unregisterGraph:new H(this)},this.hooks={save:new te(this),load:new te(this)},this.graphTemplateEvents=ie(),this.graphTemplateHooks=ie(),this.graphEvents=ie(),this.graphHooks=ie(),this.nodeEvents=ie(),this.nodeHooks=ie(),this.connectionEvents=ie(),this._graphs=new Set,this._nodeTypes=new Map,this._graph=new je(this),this._graphTemplates=[],this._loading=!1,this.registerNodeType(at),this.registerNodeType(rt)}registerNodeType(e,n){var o,s;if(this.events.beforeRegisterNodeType.emit({type:e,options:n}).prevented)return;const r=new e;this._nodeTypes.set(r.type,{type:e,category:(o=n?.category)!==null&&o!==void 0?o:"default",title:(s=n?.title)!==null&&s!==void 0?s:r.title}),this.events.registerNodeType.emit({type:e,options:n})}unregisterNodeType(e){const n=typeof e=="string"?e:new e().type;if(this.nodeTypes.has(n)){if(this.events.beforeUnregisterNodeType.emit(n).prevented)return;this._nodeTypes.delete(n),this.events.unregisterNodeType.emit(n)}}addGraphTemplate(e){if(this.events.beforeAddGraphTemplate.emit(e).prevented)return;this._graphTemplates.push(e),this.graphTemplateEvents.addTarget(e.events),this.graphTemplateHooks.addTarget(e.hooks);const n=Vn(e);this.registerNodeType(n,{category:"Subgraphs",title:e.name}),this.events.addGraphTemplate.emit(e)}removeGraphTemplate(e){if(this.graphTemplates.includes(e)){if(this.events.beforeRemoveGraphTemplate.emit(e).prevented)return;const n=Ce(e);for(const o of[this.graph,...this.graphs.values()]){const s=o.nodes.filter(r=>r.type===n);for(const r of s)o.removeNode(r)}this.unregisterNodeType(n),this._graphTemplates.splice(this._graphTemplates.indexOf(e),1),this.graphTemplateEvents.removeTarget(e.events),this.graphTemplateHooks.removeTarget(e.hooks),this.events.removeGraphTemplate.emit(e)}}registerGraph(e){this.graphEvents.addTarget(e.events),this.graphHooks.addTarget(e.hooks),this.nodeEvents.addTarget(e.nodeEvents),this.nodeHooks.addTarget(e.nodeHooks),this.connectionEvents.addTarget(e.connectionEvents),this.events.registerGraph.emit(e),this._graphs.add(e)}unregisterGraph(e){this.graphEvents.removeTarget(e.events),this.graphHooks.removeTarget(e.hooks),this.nodeEvents.removeTarget(e.nodeEvents),this.nodeHooks.removeTarget(e.nodeHooks),this.connectionEvents.removeTarget(e.connectionEvents),this.events.unregisterGraph.emit(e),this._graphs.delete(e)}load(e){try{for(this._loading=!0,e=this.hooks.load.execute(e);this.graphTemplates.length>0;)this.removeGraphTemplate(this.graphTemplates[0]);e.graphTemplates.forEach(o=>{const s=new We(o,this);this.addGraphTemplate(s)});const n=this._graph.load(e.graph);return this.events.loaded.emit(),n.forEach(o=>console.warn(o)),n}finally{this._loading=!1}}save(){const e={graph:this.graph.save(),graphTemplates:this.graphTemplates.map(n=>n.save())};return this.hooks.save.execute(e)}}const Gn=["INPUT","TEXTAREA","SELECT"];function lt(t){return Gn.includes(t.tagName)}function jn(t){return t.position}function Wn(t,e,n){t.position.x=e,t.position.y=n}let et=null;function Lt(t){et=t}function J(){if(!et)throw new Error("providePlugin() must be called before usePlugin()");return{viewModel:et}}function ee(){const{viewModel:t}=J();return{graph:me(t.value,"displayedGraph"),switchGraph:t.value.switchGraph}}function ut(t){const{graph:e}=ee(),n=E(null),o=E(null);return{dragging:N(()=>!!n.value),onPointerDown:l=>{n.value={x:l.pageX,y:l.pageY},o.value={x:t.value.x,y:t.value.y}},onPointerMove:l=>{if(n.value){const u=l.pageX-n.value.x,h=l.pageY-n.value.y;t.value.x=o.value.x+u/e.value.scaling,t.value.y=o.value.y+h/e.value.scaling}},onPointerUp:()=>{n.value=null,o.value=null}}}function Ut(t,e,n){if(!e.template)return!1;if(Ce(e.template)===n)return!0;const o=t.graphTemplates.find(r=>Ce(r)===n);return o?o.nodes.filter(r=>r.type.startsWith($e)).some(r=>Ut(t,e,r.type)):!1}function dt(t){return N(()=>{const e=Array.from(t.value.editor.nodeTypes.entries()),n=new Set(e.map(([,s])=>s.category)),o=[];for(const s of n.values()){let r=e.filter(([,i])=>i.category===s);t.value.displayedGraph.template?r=r.filter(([i])=>!Ut(t.value.editor,t.value.displayedGraph,i)):r=r.filter(([i])=>![we,_e].includes(i)),r.length>0&&o.push({name:s,nodeTypes:Object.fromEntries(r)})}return o.sort((s,r)=>s.name==="default"?-1:r.name==="default"||s.name>r.name?1:-1),o})}function ct(){const{graph:t}=ee();return{transform:(n,o)=>{const s=n/t.value.scaling-t.value.panning.x,r=o/t.value.scaling-t.value.panning.y;return[s,r]}}}function Fn(){const{graph:t}=ee();let e=[],n=-1,o={x:0,y:0};const s=N(()=>t.value.panning),r=ut(s),i=N(()=>({"transform-origin":"0 0",transform:`scale(${t.value.scaling}) translate(${t.value.panning.x}px, ${t.value.panning.y}px)`})),a=(c,d,b)=>{const f=[c/t.value.scaling-t.value.panning.x,d/t.value.scaling-t.value.panning.y],g=[c/b-t.value.panning.x,d/b-t.value.panning.y],y=[g[0]-f[0],g[1]-f[1]];t.value.panning.x+=y[0],t.value.panning.y+=y[1],t.value.scaling=b},l=c=>{c.preventDefault();let d=c.deltaY;c.deltaMode===1&&(d*=32);const b=t.value.scaling*(1-d/3e3);a(c.offsetX,c.offsetY,b)},u=()=>({ax:e[0].clientX,ay:e[0].clientY,bx:e[1].clientX,by:e[1].clientY});return{styles:i,...r,onPointerDown:c=>{if(e.push(c),r.onPointerDown(c),e.length===2){const{ax:d,ay:b,bx:f,by:g}=u();o={x:d+(f-d)/2,y:b+(g-b)/2}}},onPointerMove:c=>{for(let d=0;d<e.length;d++)if(c.pointerId==e[d].pointerId){e[d]=c;break}if(e.length==2){const{ax:d,ay:b,bx:f,by:g}=u(),y=d-f,I=b-g,S=Math.sqrt(y*y+I*I);if(n>0){const $=t.value.scaling*(1+(S-n)/500);a(o.x,o.y,$)}n=S}else r.onPointerMove(c)},onPointerUp:c=>{e=e.filter(d=>d.pointerId!==c.pointerId),n=-1,r.onPointerUp()},onMouseWheel:l}}var Q=(t=>(t[t.NONE=0]="NONE",t[t.ALLOWED=1]="ALLOWED",t[t.FORBIDDEN=2]="FORBIDDEN",t))(Q||{});const Vt=Symbol();function zt(){const{graph:t}=ee(),e=E(null),n=E(null),o=a=>{e.value&&(e.value.mx=a.offsetX/t.value.scaling-t.value.panning.x,e.value.my=a.offsetY/t.value.scaling-t.value.panning.y)},s=()=>{if(n.value){if(e.value)return;const a=t.value.connections.find(l=>l.to===n.value);n.value.isInput&&a?(e.value={status:Q.NONE,from:a.from},t.value.removeConnection(a)):e.value={status:Q.NONE,from:n.value},e.value.mx=void 0,e.value.my=void 0}},r=()=>{if(e.value&&n.value){if(e.value.from===n.value)return;t.value.addConnection(e.value.from,e.value.to)}e.value=null},i=a=>{if(n.value=a??null,a&&e.value){e.value.to=a;const l=t.value.checkConnection(e.value.from,e.value.to);if(e.value.status=l.connectionAllowed?Q.ALLOWED:Q.FORBIDDEN,l.connectionAllowed){const u=l.connectionsInDanger.map(h=>h.id);t.value.connections.forEach(h=>{u.includes(h.id)&&(h.isInDanger=!0)})}}else!a&&e.value&&(e.value.to=void 0,e.value.status=Q.NONE,t.value.connections.forEach(l=>{l.isInDanger=!1}))};return Dt(Vt,{temporaryConnection:e,hoveredOver:i}),{temporaryConnection:e,onMouseMove:o,onMouseDown:s,onMouseUp:r,hoveredOver:i}}function Gt(){const t=At(Vt);if(!t)throw new Error("useTemporaryConnection must be used within a BaklavaEditor");return t}function Xn(t){const e=E(!1),n=E(0),o=E(0),s=dt(t),{transform:r}=ct(),i=N(()=>{let h=[];const v={};for(const c of s.value){const d=Object.entries(c.nodeTypes).map(([b,f])=>({label:f.title,value:"addNode:"+b}));c.name==="default"?h=d:v[c.name]=d}const p=[...Object.entries(v).map(([c,d])=>({label:c,submenu:d}))];return p.length>0&&h.length>0&&p.push({isDivider:!0}),p.push(...h),p}),a=N(()=>t.value.settings.contextMenu.additionalItems.length===0?i.value:[{label:"Add node",submenu:i.value},...t.value.settings.contextMenu.additionalItems.map(h=>"isDivider"in h||"submenu"in h?h:{label:h.label,value:"command:"+h.command,disabled:!t.value.commandHandler.canExecuteCommand(h.command)})]);function l(h){const v=h.target;if(!(v instanceof Element)||lt(v))return;h.preventDefault(),e.value=!0;const p=v.getBoundingClientRect(),d=v.closest(".baklava-editor").getBoundingClientRect();n.value=p.x+h.offsetX-d.x,o.value=p.y+h.offsetY-d.y}function u(h){if(h.startsWith("addNode:")){const v=h.substring(8),p=t.value.editor.nodeTypes.get(v);if(!p)return;const c=ae(new p.type);t.value.displayedGraph.addNode(c);const[d,b]=r(n.value,o.value);c.position.x=d,c.position.y=b}else if(h.startsWith("command:")){const v=h.substring(8);t.value.commandHandler.canExecuteCommand(v)&&t.value.commandHandler.executeCommand(v)}}return{show:e,x:n,y:o,items:a,open:l,onClick:u}}const Ne="START_SELECTION_BOX";function Yn(t){const{viewModel:e}=J(),{graph:n}=ee(),o=N(()=>n.value.nodes),s=E(!1),r=E(!1),i=E([0,0]),a=E([0,0]);ue(e,()=>{e.value.commandHandler.hasCommand(Ne)||(e.value.commandHandler.registerCommand(Ne,{canExecute:()=>!0,execute(){s.value=!0}}),e.value.commandHandler.registerHotkey(["b"],Ne))},{immediate:!0});function l(g){return[g.clientX-t.value.getBoundingClientRect().left,g.clientY-t.value.getBoundingClientRect().top]}function u(g){return s.value?(r.value=!0,s.value=!1,i.value=l(g),a.value=l(g),document.addEventListener("pointermove",h),document.addEventListener("pointerup",v),!0):!1}function h(g){i.value=l(g)}function v(g){document.removeEventListener("pointermove",h),document.removeEventListener("pointerup",v),i.value=l(g),r.value=!1;const y=p();for(const I of y)e.value.displayedGraph.selectedNodes.push(I)}function p(){const g=c(),I=document.querySelector(".baklava-editor").getBoundingClientRect();return o.value.filter(S=>{const $=d(S,I);return b(g,$)})}function c(){return{left:Math.min(i.value[0],a.value[0]),top:Math.min(i.value[1],a.value[1]),right:Math.max(i.value[0],a.value[0]),bottom:Math.max(i.value[1],a.value[1])}}function d(g,y){const I=document.getElementById(g.id),S=I?I.getBoundingClientRect():{x:0,y:0,width:0,height:0},$=S.x-y.left,k=S.y-y.top;return{left:$,top:k,right:$+S.width,bottom:k+S.height}}function b(g,y){return g.left<y.right&&g.right>y.left&&g.top<y.bottom&&g.bottom>y.top}function f(){return{width:Math.abs(a.value[0]-i.value[0])+"px",height:Math.abs(a.value[1]-i.value[1])+"px",left:(a.value[0]>i.value[0]?i.value[0]:a.value[0])+"px",top:(a.value[1]>i.value[1]?i.value[1]:a.value[1])+"px"}}return ae({startSelection:s,isSelecting:r,start:i,end:a,onPointerDown:u,getStyles:f})}const qn=L({setup(){const{viewModel:t}=J(),{graph:e}=ee();return{styles:N(()=>{const o=t.value.settings.background,s=e.value.panning.x*e.value.scaling,r=e.value.panning.y*e.value.scaling,i=e.value.scaling*o.gridSize,a=i/o.gridDivision,l=`${i}px ${i}px, ${i}px ${i}px`,u=e.value.scaling>o.subGridVisibleThreshold?`, ${a}px ${a}px, ${a}px ${a}px`:"";return{backgroundPosition:`left ${s}px top ${r}px`,backgroundSize:`${l} ${u}`}})}}}),D=(t,e)=>{const n=t.__vccOpts||t;for(const[o,s]of e)n[o]=s;return n};function Kn(t,e,n,o,s,r){return m(),_("div",{class:"background",style:he(t.styles)},null,4)}const Zn=D(qn,[["render",Kn]]);function Jn(t){return Tn()?($n(t),!0):!1}const jt=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const Qn=Object.prototype.toString,eo=t=>Qn.call(t)==="[object Object]",be=()=>{},to=no();function no(){var t,e;return jt&&((t=window?.navigator)==null?void 0:t.userAgent)&&(/iP(?:ad|hone|od)/.test(window.navigator.userAgent)||((e=window?.navigator)==null?void 0:e.maxTouchPoints)>2&&/iPad|Macintosh/.test(window?.navigator.userAgent))}function oo(t,e,n=!1){return e.reduce((o,s)=>(s in t&&(!n||t[s]!==void 0)&&(o[s]=t[s]),o),{})}function Ze(t){return Array.isArray(t)?t:[t]}function so(t,e={}){if(!Ot(t))return Nn(t);const n=Array.isArray(t.value)?Array.from({length:t.value.length}):{};for(const o in t.value)n[o]=En(()=>({get(){return t.value[o]},set(s){var r;if((r=pe(e.replaceRef))!=null?r:!0)if(Array.isArray(t.value)){const a=[...t.value];a[o]=s,t.value=a}else{const a={...t.value,[o]:s};Object.setPrototypeOf(a,Object.getPrototypeOf(t.value)),t.value=a}else t.value[o]=s}}));return n}function io(t,e,n){return ue(t,e,{...n,immediate:!0})}const pt=jt?window:void 0;function Me(t){var e;const n=pe(t);return(e=n?.$el)!=null?e:n}function Ee(...t){const e=[],n=()=>{e.forEach(a=>a()),e.length=0},o=(a,l,u,h)=>(a.addEventListener(l,u,h),()=>a.removeEventListener(l,u,h)),s=N(()=>{const a=Ze(pe(t[0])).filter(l=>l!=null);return a.every(l=>typeof l!="string")?a:void 0}),r=io(()=>{var a,l;return[(l=(a=s.value)==null?void 0:a.map(u=>Me(u)))!=null?l:[pt].filter(u=>u!=null),Ze(pe(s.value?t[1]:t[0])),Ze(A(s.value?t[2]:t[1])),pe(s.value?t[3]:t[2])]},([a,l,u,h])=>{if(n(),!a?.length||!l?.length||!u?.length)return;const v=eo(h)?{...h}:h;e.push(...a.flatMap(p=>l.flatMap(c=>u.map(d=>o(p,c,d,v)))))},{flush:"post"}),i=()=>{r(),n()};return Jn(n),i}let xt=!1;function Wt(t,e,n={}){const{window:o=pt,ignore:s=[],capture:r=!0,detectIframe:i=!1,controls:a=!1}=n;if(!o)return a?{stop:be,cancel:be,trigger:be}:be;if(to&&!xt){xt=!0;const f={passive:!0};Array.from(o.document.body.children).forEach(g=>g.addEventListener("click",be,f)),o.document.documentElement.addEventListener("click",be,f)}let l=!0;const u=f=>pe(s).some(g=>{if(typeof g=="string")return Array.from(o.document.querySelectorAll(g)).some(y=>y===f.target||f.composedPath().includes(y));{const y=Me(g);return y&&(f.target===y||f.composedPath().includes(y))}});function h(f){const g=pe(f);return g&&g.$.subTree.shapeFlag===16}function v(f,g){const y=pe(f),I=y.$.subTree&&y.$.subTree.children;return I==null||!Array.isArray(I)?!1:I.some(S=>S.el===g.target||g.composedPath().includes(S.el))}const p=f=>{const g=Me(t);if(f.target!=null&&!(!(g instanceof Element)&&h(t)&&v(t,f))&&!(!g||g===f.target||f.composedPath().includes(g))){if("detail"in f&&f.detail===0&&(l=!u(f)),!l){l=!0;return}e(f)}};let c=!1;const d=[Ee(o,"click",f=>{c||(c=!0,setTimeout(()=>{c=!1},0),p(f))},{passive:!0,capture:r}),Ee(o,"pointerdown",f=>{const g=Me(t);l=!u(f)&&!!(g&&!f.composedPath().includes(g))},{passive:!0}),i&&Ee(o,"blur",f=>{setTimeout(()=>{var g;const y=Me(t);((g=o.document.activeElement)==null?void 0:g.tagName)==="IFRAME"&&!y?.contains(o.document.activeElement)&&e(f)},0)},{passive:!0})].filter(Boolean),b=()=>d.forEach(f=>f());return a?{stop:b,cancel:()=>{l=!1},trigger:f=>{l=!0,p(f),l=!1}}:b}const Ft={x:0,y:0,pointerId:0,pressure:0,tiltX:0,tiltY:0,width:0,height:0,twist:0,pointerType:null},ao=Object.keys(Ft);function ro(t={}){const{target:e=pt}=t,n=Mn(!1),o=E(t.initialValue||{});Object.assign(o.value,Ft,o.value);const s=r=>{n.value=!0,!(t.pointerTypes&&!t.pointerTypes.includes(r.pointerType))&&(o.value=oo(r,ao,!1))};if(e){const r={passive:!0};Ee(e,["pointerdown","pointermove","pointerup"],s,r),Ee(e,"pointerleave",()=>n.value=!1,r)}return{...so(o),isInside:n}}const lo=["onMouseenter","onMouseleave","onClick"],uo={class:"flex-fill"},co={key:0,class:"__submenu-icon",style:{"line-height":"1em"}},Fe=L({__name:"ContextMenu",props:{modelValue:{type:Boolean},items:{},x:{default:0},y:{default:0},isNested:{type:Boolean,default:!1},isFlipped:{default:()=>({x:!1,y:!1})},flippable:{type:Boolean,default:!1}},emits:["update:modelValue","click"],setup(t,{emit:e}){const n=t,o=e;let s=null;const r=E(null),i=E(-1),a=E(0),l=E({x:!1,y:!1}),u=N(()=>n.flippable&&(l.value.x||n.isFlipped.x)),h=N(()=>n.flippable&&(l.value.y||n.isFlipped.y)),v=N(()=>{const y={};return n.isNested||(y.top=(h.value?n.y-a.value:n.y)+"px",y.left=n.x+"px"),y}),p=N(()=>({"--flipped-x":u.value,"--flipped-y":h.value,"--nested":n.isNested})),c=N(()=>n.items.map(y=>({...y,hover:!1})));ue([()=>n.y,()=>n.items],()=>{var y,I,S,$;a.value=n.items.length*30;const k=((I=(y=r.value)==null?void 0:y.parentElement)==null?void 0:I.offsetWidth)??0,O=(($=(S=r.value)==null?void 0:S.parentElement)==null?void 0:$.offsetHeight)??0;l.value.x=!n.isNested&&n.x>k*.75,l.value.y=!n.isNested&&n.y+a.value>O-20}),Wt(r,()=>{n.modelValue&&o("update:modelValue",!1)});const d=y=>{!y.submenu&&y.value&&(o("click",y.value),o("update:modelValue",!1))},b=y=>{o("click",y),i.value=-1,n.isNested||o("update:modelValue",!1)},f=(y,I)=>{n.items[I].submenu&&(i.value=I,s!==null&&(clearTimeout(s),s=null))},g=(y,I)=>{n.items[I].submenu&&(s=window.setTimeout(()=>{i.value=-1,s=null},200))};return(y,I)=>{const S=ge("ContextMenu",!0);return m(),F(st,{name:"slide-fade"},{default:Ve(()=>[ve(C("div",{ref_key:"el",ref:r,class:X(["baklava-context-menu",p.value]),style:he(v.value)},[(m(!0),_(q,null,ne(c.value,($,k)=>(m(),_(q,null,[$.isDivider?(m(),_("div",{key:`d-${k}`,class:"divider"})):(m(),_("div",{key:`i-${k}`,class:X(["item",{submenu:!!$.submenu,"--disabled":!!$.disabled}]),onMouseenter:O=>f(O,k),onMouseleave:O=>g(O,k),onClick:K(O=>d($),["stop","prevent"])},[C("div",uo,U($.label),1),$.submenu?(m(),_("div",co,I[0]||(I[0]=[C("svg",{width:"13",height:"13",viewBox:"-60 120 250 250"},[C("path",{d:"M160.875 279.5625 L70.875 369.5625 L70.875 189.5625 L160.875 279.5625 Z",stroke:"none",fill:"white"})],-1)]))):j("",!0),$.submenu?(m(),F(S,{key:1,"model-value":i.value===k,items:$.submenu,"is-nested":!0,"is-flipped":{x:u.value,y:h.value},flippable:y.flippable,onClick:b},null,8,["model-value","items","is-flipped","flippable"])):j("",!0)],42,lo))],64))),256))],6),[[Rt,y.modelValue]])]),_:1})}}}),po={},ho={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"16",height:"16",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function vo(t,e){return m(),_("svg",ho,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("circle",{cx:"12",cy:"12",r:"1"},null,-1),C("circle",{cx:"12",cy:"19",r:"1"},null,-1),C("circle",{cx:"12",cy:"5",r:"1"},null,-1)]))}const Xt=D(po,[["render",vo]]),fo=["id"],mo={key:0,class:"__tooltip"},go={key:2,class:"align-middle"},tt=L({__name:"NodeInterface",props:{node:{},intf:{}},setup(t){const e=(f,g=100)=>{const y=typeof f?.toString=="function"?String(f):"";return y.length>g?y.slice(0,g)+"...":y},n=t,{viewModel:o}=J(),{hoveredOver:s,temporaryConnection:r}=Gt(),i=E(null),a=N(()=>n.intf.connectionCount>0),l=E(!1),u=N(()=>o.value.settings.displayValueOnHover&&l.value),h=N(()=>({"--input":n.intf.isInput,"--output":!n.intf.isInput,"--connected":a.value})),v=N(()=>n.intf.component&&(!n.intf.isInput||!n.intf.port||n.intf.connectionCount===0)),p=()=>{l.value=!0,s(n.intf)},c=()=>{l.value=!1,s(void 0)},d=()=>{i.value&&o.value.hooks.renderInterface.execute({intf:n.intf,el:i.value})},b=()=>{const f=o.value.displayedGraph.sidebar;f.nodeId=n.node.id,f.optionName=n.intf.name,f.visible=!0};return ze(d),Pt(d),(f,g)=>{var y;return m(),_("div",{id:f.intf.id,ref_key:"el",ref:i,class:X(["baklava-node-interface",h.value])},[f.intf.port?(m(),_("div",{key:0,class:X(["__port",{"--selected":((y=A(r))==null?void 0:y.from)===f.intf}]),onPointerover:p,onPointerout:c},[Z(f.$slots,"portTooltip",{showTooltip:u.value},()=>[u.value===!0?(m(),_("span",mo,U(e(f.intf.value)),1)):j("",!0)])],34)):j("",!0),v.value?(m(),F(it(f.intf.component),{key:1,modelValue:f.intf.value,"onUpdate:modelValue":g[0]||(g[0]=I=>f.intf.value=I),node:f.node,intf:f.intf,onOpenSidebar:b},null,40,["modelValue","node","intf"])):(m(),_("span",go,U(f.intf.name),1))],10,fo)}}}),yo=["id","data-node-type"],bo={class:"__title-label"},wo={class:"__menu"},_o={class:"__outputs"},Co={class:"__inputs"},Yt=L({__name:"Node",props:{node:{},selected:{type:Boolean,default:!1},dragging:{type:Boolean}},emits:["select","start-drag"],setup(t,{emit:e}){const n=t,o=e,{viewModel:s}=J(),{graph:r,switchGraph:i}=ee(),a=E(null),l=E(!1),u=E(""),h=E(null),v=E(!1);let p=0,c=0;const d=E(!1),b=N(()=>{const x=[{value:"rename",label:"Rename"},{value:"delete",label:"Delete"}];return n.node.type.startsWith($e)&&x.push({value:"editSubgraph",label:"Edit Subgraph"}),x}),f=N(()=>({"--selected":n.selected,"--dragging":n.dragging,"--two-column":!!n.node.twoColumn})),g=N(()=>({"--reverse-y":n.node.reverseY??s.value.settings.nodes.reverseY})),y=N(()=>{var x,P;return{top:`${((x=n.node.position)==null?void 0:x.y)??0}px`,left:`${((P=n.node.position)==null?void 0:P.x)??0}px`,"--width":`${n.node.width??s.value.settings.nodes.defaultWidth}px`}}),I=N(()=>Object.values(n.node.inputs).filter(x=>!x.hidden)),S=N(()=>Object.values(n.node.outputs).filter(x=>!x.hidden)),$=()=>{o("select")},k=x=>{n.selected||$(),o("start-drag",x)},O=()=>{d.value=!0},M=async x=>{var P;switch(x){case"delete":r.value.removeNode(n.node);break;case"rename":u.value=n.node.title,l.value=!0,await ot(),(P=h.value)==null||P.focus();break;case"editSubgraph":i(n.node.template);break}},w=()=>{n.node.title=u.value,l.value=!1},T=()=>{a.value&&s.value.hooks.renderNode.execute({node:n.node,el:a.value})},B=x=>{v.value=!0,p=n.node.width,c=x.clientX,x.preventDefault()},re=x=>{if(!v.value)return;const P=x.clientX-c,R=p+P/r.value.scaling,oe=s.value.settings.nodes.minWidth,se=s.value.settings.nodes.maxWidth;n.node.width=Math.max(oe,Math.min(se,R))},Ie=()=>{v.value=!1};return ze(()=>{T(),window.addEventListener("mousemove",re),window.addEventListener("mouseup",Ie)}),Pt(T),nt(()=>{window.removeEventListener("mousemove",re),window.removeEventListener("mouseup",Ie)}),(x,P)=>(m(),_("div",{id:x.node.id,ref_key:"el",ref:a,class:X(["baklava-node",f.value]),style:he(y.value),"data-node-type":x.node.type,onPointerdown:$},[A(s).settings.nodes.resizable?(m(),_("div",{key:0,class:"__resize-handle",onMousedown:B},null,32)):j("",!0),Z(x.$slots,"title",{},()=>[C("div",{class:"__title",onPointerdown:K(k,["self","stop"]),onContextmenu:K(O,["prevent"])},[l.value?ve((m(),_("input",{key:1,ref_key:"renameInputEl",ref:h,"onUpdate:modelValue":P[1]||(P[1]=R=>u.value=R),type:"text",class:"baklava-input",placeholder:"Node Name",onBlur:w,onKeydown:Te(w,["enter"])},null,544)),[[ke,u.value]]):(m(),_(q,{key:0},[C("div",bo,U(x.node.title),1),C("div",wo,[V(Xt,{class:"--clickable",onClick:O}),V(A(Fe),{modelValue:d.value,"onUpdate:modelValue":P[0]||(P[0]=R=>d.value=R),x:0,y:0,items:b.value,onClick:M},null,8,["modelValue","items"])])],64))],32)]),Z(x.$slots,"content",{},()=>[C("div",{class:X(["__content",g.value]),onKeydown:P[2]||(P[2]=Te(K(()=>{},["stop"]),["delete"]))},[C("div",_o,[(m(!0),_(q,null,ne(S.value,R=>Z(x.$slots,"nodeInterface",{key:R.id,type:"output",node:x.node,intf:R},()=>[V(tt,{node:x.node,intf:R},null,8,["node","intf"])])),128))]),C("div",Co,[(m(!0),_(q,null,ne(I.value,R=>Z(x.$slots,"nodeInterface",{key:R.id,type:"input",node:x.node,intf:R},()=>[V(tt,{node:x.node,intf:R},null,8,["node","intf"])])),128))])],34)])],46,yo))}}),xo=L({props:{x1:{type:Number,required:!0},y1:{type:Number,required:!0},x2:{type:Number,required:!0},y2:{type:Number,required:!0},state:{type:Number,default:Q.NONE},isTemporary:{type:Boolean,default:!1}},setup(t){const{viewModel:e}=J(),{graph:n}=ee(),o=(i,a)=>{const l=(i+n.value.panning.x)*n.value.scaling,u=(a+n.value.panning.y)*n.value.scaling;return[l,u]},s=N(()=>{const[i,a]=o(t.x1,t.y1),[l,u]=o(t.x2,t.y2);if(e.value.settings.useStraightConnections)return`M ${i} ${a} L ${l} ${u}`;{const h=.3*Math.abs(i-l);return`M ${i} ${a} C ${i+h} ${a}, ${l-h} ${u}, ${l} ${u}`}}),r=N(()=>({"--temporary":t.isTemporary,"--allowed":t.state===Q.ALLOWED,"--forbidden":t.state===Q.FORBIDDEN}));return{d:s,classes:r}}}),ko=["d"];function Io(t,e,n,o,s,r){return m(),_("path",{class:X(["baklava-connection",t.classes]),d:t.d},null,10,ko)}const ht=D(xo,[["render",Io]]);function qt(t){return document.getElementById(t.id)}function ye(t){const e=document.getElementById(t.id),n=e?.getElementsByClassName("__port");return{node:e?.closest(".baklava-node")??null,interface:e,port:n&&n.length>0?n[0]:null}}const Mo=L({components:{"connection-view":ht},props:{connection:{type:Object,required:!0}},setup(t){const{graph:e}=ee();let n;const o=E({x1:0,y1:0,x2:0,y2:0}),s=N(()=>t.connection.isInDanger?Q.FORBIDDEN:Q.NONE),r=N(()=>{var u;return(u=e.value.findNodeById(t.connection.from.nodeId))==null?void 0:u.position}),i=N(()=>{var u;return(u=e.value.findNodeById(t.connection.to.nodeId))==null?void 0:u.position}),a=u=>u.node&&u.interface&&u.port?[u.node.offsetLeft+u.interface.offsetLeft+u.port.offsetLeft+u.port.clientWidth/2,u.node.offsetTop+u.interface.offsetTop+u.port.offsetTop+u.port.clientHeight/2]:[0,0],l=()=>{const u=ye(t.connection.from),h=ye(t.connection.to);u.node&&h.node&&(n||(n=new ResizeObserver(()=>{l()}),n.observe(u.node),n.observe(h.node)));const[v,p]=a(u),[c,d]=a(h);o.value={x1:v,y1:p,x2:c,y2:d}};return ze(async()=>{await ot(),l()}),nt(()=>{n&&n.disconnect()}),ue([r,i],()=>l(),{deep:!0}),{d:o,state:s}}});function No(t,e,n,o,s,r){const i=ge("connection-view");return m(),F(i,{x1:t.d.x1,y1:t.d.y1,x2:t.d.x2,y2:t.d.y2,state:t.state},null,8,["x1","y1","x2","y2","state"])}const Kt=D(Mo,[["render",No]]);function Se(t){return t.node&&t.interface&&t.port?[t.node.offsetLeft+t.interface.offsetLeft+t.port.offsetLeft+t.port.clientWidth/2,t.node.offsetTop+t.interface.offsetTop+t.port.offsetTop+t.port.clientHeight/2]:[0,0]}const Eo=L({components:{"connection-view":ht},props:{connection:{type:Object,required:!0}},setup(t){const e=N(()=>t.connection?t.connection.status:Q.NONE);return{d:N(()=>{if(!t.connection)return{input:[0,0],output:[0,0]};const o=Se(ye(t.connection.from)),s=t.connection.to?Se(ye(t.connection.to)):[t.connection.mx||o[0],t.connection.my||o[1]];return t.connection.from.isInput?{input:s,output:o}:{input:o,output:s}}),status:e}}});function To(t,e,n,o,s,r){const i=ge("connection-view");return m(),F(i,{x1:t.d.input[0],y1:t.d.input[1],x2:t.d.output[0],y2:t.d.output[1],state:t.status,"is-temporary":""},null,8,["x1","y1","x2","y2","state"])}const Zt=D(Eo,[["render",To]]),$o=L({setup(){const{viewModel:t}=J(),{graph:e}=ee(),n=E(null),o=me(t.value.settings.sidebar,"width"),s=N(()=>t.value.settings.sidebar.resizable);let r=0,i=0;const a=N(()=>{const c=e.value.sidebar.nodeId;return e.value.nodes.find(d=>d.id===c)}),l=N(()=>({width:`${o.value}px`})),u=N(()=>a.value?[...Object.values(a.value.inputs),...Object.values(a.value.outputs)].filter(d=>d.displayInSidebar&&d.component):[]),h=()=>{e.value.sidebar.visible=!1},v=c=>{r=o.value,i=c.clientX,window.addEventListener("mousemove",p),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",p)},{once:!0})},p=c=>{var d,b;const f=((b=(d=n.value)==null?void 0:d.parentElement)==null?void 0:b.getBoundingClientRect().width)??500,g=c.clientX-i;let y=r-g;y<300?y=300:y>.9*f&&(y=.9*f),o.value=y};return{el:n,graph:e,resizable:s,node:a,styles:l,displayedInterfaces:u,startResize:v,close:h}}}),So={class:"__header"},Oo={class:"__node-name"};function Ao(t,e,n,o,s,r){return m(),_("div",{ref:"el",class:X(["baklava-sidebar",{"--open":t.graph.sidebar.visible}]),style:he(t.styles)},[t.resizable?(m(),_("div",{key:0,class:"__resizer",onMousedown:e[0]||(e[0]=(...i)=>t.startResize&&t.startResize(...i))},null,32)):j("",!0),C("div",So,[C("button",{tabindex:"-1",class:"__close",onClick:e[1]||(e[1]=(...i)=>t.close&&t.close(...i))},"×"),C("div",Oo,[C("b",null,U(t.node?t.node.title:""),1)])]),(m(!0),_(q,null,ne(t.displayedInterfaces,i=>(m(),_("div",{key:i.id,class:"__interface"},[(m(),F(it(i.component),{modelValue:i.value,"onUpdate:modelValue":a=>i.value=a,node:t.node,intf:i},null,8,["modelValue","onUpdate:modelValue","node","intf"]))]))),128))],6)}const Jt=D($o,[["render",Ao]]),Qt=L({__name:"Minimap",setup(t){const{viewModel:e}=J(),{graph:n}=ee(),o=E(null),s=E(!1);let r,i=!1,a={x1:0,y1:0,x2:0,y2:0},l;const u=()=>{var k,O;if(!r)return;r.canvas.width=o.value.offsetWidth,r.canvas.height=o.value.offsetHeight;const M=new Map,w=new Map;for(const x of n.value.nodes){const P=qt(x),R=P?.offsetWidth??0,oe=P?.offsetHeight??0,se=((k=x.position)==null?void 0:k.x)??0,ce=((O=x.position)==null?void 0:O.y)??0;M.set(x,{x1:se,y1:ce,x2:se+R,y2:ce+oe}),w.set(x,P)}const T={x1:Number.MAX_SAFE_INTEGER,y1:Number.MAX_SAFE_INTEGER,x2:Number.MIN_SAFE_INTEGER,y2:Number.MIN_SAFE_INTEGER};for(const x of M.values())x.x1<T.x1&&(T.x1=x.x1),x.y1<T.y1&&(T.y1=x.y1),x.x2>T.x2&&(T.x2=x.x2),x.y2>T.y2&&(T.y2=x.y2);const B=50;T.x1-=B,T.y1-=B,T.x2+=B,T.y2+=B,a=T;const re=r.canvas.width/r.canvas.height,Ie=(a.x2-a.x1)/(a.y2-a.y1);if(re>Ie){const x=(re-Ie)*(a.y2-a.y1)*.5;a.x1-=x,a.x2+=x}else{const x=a.x2-a.x1,P=a.y2-a.y1,R=(x-re*P)/re*.5;a.y1-=R,a.y2+=R}r.clearRect(0,0,r.canvas.width,r.canvas.height),r.strokeStyle="white";for(const x of n.value.connections){const[P,R]=Se(ye(x.from)),[oe,se]=Se(ye(x.to)),[ce,bt]=h(P,R),[Oe,qe]=h(oe,se);if(r.beginPath(),r.moveTo(ce,bt),e.value.settings.useStraightConnections)r.lineTo(Oe,qe);else{const wt=.3*Math.abs(ce-Oe);r.bezierCurveTo(ce+wt,bt,Oe-wt,qe,Oe,qe)}r.stroke()}r.strokeStyle="lightgray";for(const[x,P]of M.entries()){const[R,oe]=h(P.x1,P.y1),[se,ce]=h(P.x2,P.y2);r.fillStyle=p(w.get(x)),r.beginPath(),r.rect(R,oe,se-R,ce-oe),r.fill(),r.stroke()}if(s.value){const x=d(),[P,R]=h(x.x1,x.y1),[oe,se]=h(x.x2,x.y2);r.fillStyle="rgba(255, 255, 255, 0.2)",r.fillRect(P,R,oe-P,se-R)}},h=(k,O)=>[(k-a.x1)/(a.x2-a.x1)*r.canvas.width,(O-a.y1)/(a.y2-a.y1)*r.canvas.height],v=(k,O)=>[k*(a.x2-a.x1)/r.canvas.width+a.x1,O*(a.y2-a.y1)/r.canvas.height+a.y1],p=k=>{if(k){const O=k.querySelector(".__content");if(O){const w=c(O);if(w)return w}const M=c(k);if(M)return M}return"gray"},c=k=>{const O=getComputedStyle(k).backgroundColor;if(O&&O!=="rgba(0, 0, 0, 0)")return O},d=()=>{const k=o.value.parentElement.offsetWidth,O=o.value.parentElement.offsetHeight,M=k/n.value.scaling-n.value.panning.x,w=O/n.value.scaling-n.value.panning.y;return{x1:-n.value.panning.x,y1:-n.value.panning.y,x2:M,y2:w}},b=k=>{k.button===0&&(i=!0,f(k))},f=k=>{if(i){const[O,M]=v(k.offsetX,k.offsetY),w=d(),T=(w.x2-w.x1)/2,B=(w.y2-w.y1)/2;n.value.panning.x=-(O-T),n.value.panning.y=-(M-B)}},g=()=>{i=!1},y=()=>{s.value=!0},I=()=>{s.value=!1,g()};ue([s,n.value.panning,()=>n.value.scaling,()=>n.value.connections.length],()=>{u()});const S=N(()=>n.value.nodes.map(k=>k.position)),$=N(()=>n.value.nodes.map(k=>k.width));return ue([S,$],()=>{u()},{deep:!0}),ze(()=>{r=o.value.getContext("2d"),r.imageSmoothingQuality="high",u(),l=setInterval(u,500)}),nt(()=>{clearInterval(l)}),(k,O)=>(m(),_("canvas",{ref_key:"canvas",ref:o,class:"baklava-minimap",onMouseenter:y,onMouseleave:I,onMousedown:K(b,["self"]),onMousemove:K(f,["self"]),onMouseup:g,onContextmenu:O[0]||(O[0]=K(()=>{},["stop","prevent"]))},null,544))}}),Po=L({components:{ContextMenu:Fe,VerticalDots:Xt},props:{type:{type:String,required:!0},title:{type:String,required:!0}},setup(t){const{viewModel:e}=J(),{switchGraph:n}=ee(),o=E(!1),s=N(()=>t.type.startsWith($e));return{showContextMenu:o,hasContextMenu:s,contextMenuItems:[{label:"Edit Subgraph",value:"editSubgraph"},{label:"Delete Subgraph",value:"deleteSubgraph"}],openContextMenu:()=>{o.value=!0},onContextMenuClick:l=>{const u=t.type.substring($e.length),h=e.value.editor.graphTemplates.find(v=>v.id===u);if(h)switch(l){case"editSubgraph":n(h);break;case"deleteSubgraph":e.value.editor.removeGraphTemplate(h);break}}}}}),Ro=["data-node-type"],Do={class:"__title"},Bo={class:"__title-label"},Ho={key:0,class:"__menu"};function Lo(t,e,n,o,s,r){const i=ge("vertical-dots"),a=ge("context-menu");return m(),_("div",{class:"baklava-node --palette","data-node-type":t.type},[C("div",Do,[C("div",Bo,U(t.title),1),t.hasContextMenu?(m(),_("div",Ho,[V(i,{class:"--clickable",onPointerdown:e[0]||(e[0]=K(()=>{},["stop","prevent"])),onClick:K(t.openContextMenu,["stop","prevent"])},null,8,["onClick"]),V(a,{modelValue:t.showContextMenu,"onUpdate:modelValue":e[1]||(e[1]=l=>t.showContextMenu=l),x:-100,y:0,items:t.contextMenuItems,onClick:t.onContextMenuClick,onPointerdown:e[2]||(e[2]=K(()=>{},["stop","prevent"]))},null,8,["modelValue","items","onClick"])])):j("",!0)])],8,Ro)}const kt=D(Po,[["render",Lo]]),Uo={key:0},en=L({__name:"NodePalette",setup(t){const{viewModel:e}=J(),{x:n,y:o}=ro(),{transform:s}=ct(),r=dt(e),i=At("editorEl"),a=E(null),l=N(()=>{if(!a.value||!i?.value)return{};const{left:h,top:v}=i.value.getBoundingClientRect();return{top:`${o.value-v}px`,left:`${n.value-h}px`}}),u=(h,v)=>{a.value={type:h,nodeInformation:v};const p=()=>{const c=ae(new v.type);e.value.displayedGraph.addNode(c);const d=i.value.getBoundingClientRect(),[b,f]=s(n.value-d.left,o.value-d.top);c.position.x=b,c.position.y=f,a.value=null,document.removeEventListener("pointerup",p)};document.addEventListener("pointerup",p)};return(h,v)=>(m(),_(q,null,[C("div",{class:"baklava-node-palette",onContextmenu:v[0]||(v[0]=K(()=>{},["stop","prevent"]))},[(m(!0),_(q,null,ne(A(r),p=>(m(),_("section",{key:p.name},[p.name!=="default"?(m(),_("h1",Uo,U(p.name),1)):j("",!0),(m(!0),_(q,null,ne(p.nodeTypes,(c,d)=>(m(),F(kt,{key:d,type:d,title:c.title,onPointerdown:b=>u(d,c)},null,8,["type","title","onPointerdown"]))),128))]))),128))],32),V(st,{name:"fade"},{default:Ve(()=>[a.value?(m(),_("div",{key:0,class:"baklava-dragged-node",style:he(l.value)},[V(kt,{type:a.value.type,title:a.value.nodeInformation.title},null,8,["type","title"])],4)):j("",!0)]),_:1})],64))}}),Vo=L({props:{command:{type:String,required:!0},title:{type:String,required:!0},icon:{type:Object,required:!1,default:void 0}},setup(){const{viewModel:t}=J();return{viewModel:t}}}),zo=["disabled","title"];function Go(t,e,n,o,s,r){return m(),_("button",{class:"baklava-toolbar-entry baklava-toolbar-button",disabled:!t.viewModel.commandHandler.canExecuteCommand(t.command),title:t.title,onClick:e[0]||(e[0]=i=>t.viewModel.commandHandler.executeCommand(t.command))},[t.icon?(m(),F(it(t.icon),{key:0})):(m(),_(q,{key:1},[Sn(U(t.title),1)],64))],8,zo)}const It=D(Vo,[["render",Go]]),jo=L({__name:"Toolbar",setup(t){const{viewModel:e}=J(),n=N(()=>e.value.displayedGraph!==e.value.editor.graph),o=N(()=>e.value.settings.toolbar.commands),s=N(()=>e.value.settings.toolbar.subgraphCommands);return(r,i)=>(m(),_("div",{class:"baklava-toolbar",onContextmenu:i[0]||(i[0]=K(()=>{},["stop","prevent"]))},[(m(!0),_(q,null,ne(o.value,a=>(m(),F(It,{key:a.command,command:a.command,title:a.title,icon:a.icon},null,8,["command","title","icon"]))),128)),n.value?(m(!0),_(q,{key:0},ne(s.value,a=>(m(),F(It,{key:a.command,command:a.command,title:a.title,icon:a.icon},null,8,["command","title","icon"]))),128)):j("",!0)],32))}}),Wo={class:"connections-container"},Mt=L({__name:"Editor",props:{viewModel:{}},setup(t){const e=t,n=Symbol("EditorToken"),o=me(e,"viewModel");Lt(o);const s=E(null);Dt("editorEl",s);const r=N(()=>e.viewModel.displayedGraph.nodes),i=N(()=>e.viewModel.displayedGraph.nodes.map(M=>ut(me(M,"position")))),a=N(()=>e.viewModel.displayedGraph.connections),l=N(()=>e.viewModel.displayedGraph.selectedNodes),u=Fn(),h=zt(),v=Xn(o),p=Yn(s),c=N(()=>({...u.styles.value})),d=E(0);e.viewModel.editor.hooks.load.subscribe(n,M=>(d.value++,M));const b=M=>{u.onPointerMove(M),h.onMouseMove(M)},f=M=>{if(M.button===0){if(p.onPointerDown(M))return;M.target===s.value&&($(),u.onPointerDown(M)),h.onMouseDown()}},g=M=>{u.onPointerUp(M),h.onMouseUp()},y=M=>{M.key==="Tab"&&M.preventDefault(),e.viewModel.commandHandler.handleKeyDown(M)},I=M=>{e.viewModel.commandHandler.handleKeyUp(M)},S=M=>{["Control","Shift"].some(w=>e.viewModel.commandHandler.pressedKeys.includes(w))||$(),e.viewModel.displayedGraph.selectedNodes.push(M)},$=()=>{e.viewModel.displayedGraph.selectedNodes=[]},k=M=>{for(const w of e.viewModel.displayedGraph.selectedNodes){const T=r.value.indexOf(w),B=i.value[T];B.onPointerDown(M),document.addEventListener("pointermove",B.onPointerMove)}document.addEventListener("pointerup",O)},O=()=>{for(const M of e.viewModel.displayedGraph.selectedNodes){const w=r.value.indexOf(M),T=i.value[w];T.onPointerUp(),document.removeEventListener("pointermove",T.onPointerMove)}document.removeEventListener("pointerup",O)};return(M,w)=>(m(),_("div",{ref_key:"el",ref:s,tabindex:"-1",class:X(["baklava-editor",{"baklava-ignore-mouse":!!A(h).temporaryConnection.value||A(u).dragging.value,"--temporary-connection":!!A(h).temporaryConnection.value,"--start-selection-box":A(p).startSelection}]),onPointermove:K(b,["self"]),onPointerdown:f,onPointerup:g,onWheel:w[1]||(w[1]=K((...T)=>A(u).onMouseWheel&&A(u).onMouseWheel(...T),["self"])),onKeydown:y,onKeyup:I,onContextmenu:w[2]||(w[2]=K((...T)=>A(v).open&&A(v).open(...T),["self"]))},[Z(M.$slots,"background",{},()=>[V(Zn)]),Z(M.$slots,"toolbar",{},()=>[M.viewModel.settings.toolbar.enabled?(m(),F(jo,{key:0})):j("",!0)]),Z(M.$slots,"palette",{},()=>[M.viewModel.settings.palette.enabled?(m(),F(en,{key:0})):j("",!0)]),(m(),_("svg",Wo,[(m(!0),_(q,null,ne(a.value,T=>(m(),_("g",{key:T.id+d.value.toString()},[Z(M.$slots,"connection",{connection:T},()=>[V(Kt,{connection:T},null,8,["connection"])])]))),128)),Z(M.$slots,"temporaryConnection",{temporaryConnection:A(h).temporaryConnection.value},()=>[A(h).temporaryConnection.value?(m(),F(Zt,{key:0,connection:A(h).temporaryConnection.value},null,8,["connection"])):j("",!0)])])),C("div",{class:"node-container",style:he(c.value)},[V(kn,{name:"fade"},{default:Ve(()=>[(m(!0),_(q,null,ne(r.value,(T,B)=>Z(M.$slots,"node",{key:T.id+d.value.toString(),node:T,selected:l.value.includes(T),dragging:i.value[B].dragging.value,onSelect:re=>S(T),onStartDrag:k},()=>[V(Yt,{node:T,selected:l.value.includes(T),dragging:i.value[B].dragging.value,onSelect:re=>S(T),onStartDrag:k},null,8,["node","selected","dragging","onSelect"])])),128))]),_:3})],4),Z(M.$slots,"sidebar",{},()=>[M.viewModel.settings.sidebar.enabled?(m(),F(Jt,{key:0})):j("",!0)]),Z(M.$slots,"minimap",{},()=>[M.viewModel.settings.enableMinimap?(m(),F(Qt,{key:0})):j("",!0)]),Z(M.$slots,"contextMenu",{contextMenu:A(v)},()=>[M.viewModel.settings.contextMenu.enabled?(m(),F(Fe,{key:0,modelValue:A(v).show.value,"onUpdate:modelValue":w[0]||(w[0]=T=>A(v).show.value=T),items:A(v).items.value,x:A(v).x.value,y:A(v).y.value,onClick:A(v).onClick},null,8,["modelValue","items","x","y","onClick"])):j("",!0)]),A(p).isSelecting?(m(),_("div",{key:0,class:"selection-box",style:he(A(p).getStyles())},null,4)):j("",!0)],34))}});function Fo(t){const e=E([]),n=E([]);return{pressedKeys:e,handleKeyDown:i=>{e.value.includes(i.key)||e.value.push(i.key),!(document.activeElement&&lt(document.activeElement))&&n.value.forEach(a=>{var l,u;a.keys.every(h=>e.value.includes(h))&&((l=a.options)!=null&&l.preventDefault&&i.preventDefault(),(u=a.options)!=null&&u.stopPropagation&&i.stopPropagation(),t(a.commandName))})},handleKeyUp:i=>{const a=e.value.indexOf(i.key);a>=0&&e.value.splice(a,1)},registerHotkey:(i,a,l)=>{n.value.push({keys:i,commandName:a,options:l})}}}const tn=()=>{const t=E(new Map),e=i=>t.value.has(i),n=(i,a)=>{if(t.value.has(i))throw new Error(`Command "${i}" already exists`);t.value.set(i,a)},o=(i,a=!1,...l)=>{if(!t.value.has(i)){if(a)throw new Error(`[CommandHandler] Command ${i} not registered`);return}return t.value.get(i).execute(...l)},s=(i,a=!1,...l)=>{if(!t.value.has(i)){if(a)throw new Error(`[CommandHandler] Command ${i} not registered`);return!1}return t.value.get(i).canExecute(l)},r=Fo(o);return ae({hasCommand:e,registerCommand:n,executeCommand:o,canExecuteCommand:s,...r})},Xo=L({props:{intf:{type:Object,required:!0}},setup(t){return{onClick:()=>{t.intf.callback&&t.intf.callback()}}}}),Yo=["title"];function qo(t,e,n,o,s,r){return m(),_("button",{class:"baklava-button --block",title:t.intf.name,onClick:e[0]||(e[0]=(...i)=>t.onClick&&t.onClick(...i))},U(t.intf.name),9,Yo)}const nn=D(Xo,[["render",qo]]);class Ko extends W{constructor(e,n){super(e,void 0),this.component=de(nn),this.callback=n,this.setPort(!1)}}const Zo=["title"],Jo={class:"__label"},on=L({__name:"CheckboxInterface",props:{modelValue:{type:Boolean},intf:{}},emits:["update:modelValue"],setup(t,{emit:e}){const n=e;return(o,s)=>(m(),_("div",{class:X(["baklava-checkbox",{"--checked":o.modelValue}]),title:o.intf.name,onClick:s[0]||(s[0]=r=>n("update:modelValue",!o.modelValue))},[s[1]||(s[1]=C("div",{class:"__checkmark-container"},[C("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 18 18"},[C("path",{class:"__checkmark",d:"M 6 5 L 6 10 L 16 10",transform:"rotate(-45 10 10)"})])],-1)),C("div",Jo,U(o.intf.name),1)],10,Zo))}});class Qo extends W{constructor(){super(...arguments),this.component=de(on)}}const Nt=9;function es(t){return"validate"in t}class vt extends W{constructor(e,n,o,s){super(e,n),this.min=o,this.max=s}validate(e){return(this.min===void 0||e>=this.min)&&(this.max===void 0||e<=this.max)}}const ft=(t,e=3)=>{const n=E(null),o=E(!1),s=E(!1),r=E("0"),i=N(()=>{const v=t.value.value.toFixed(e);return v.length>Nt?t.value.value.toExponential(Nt-5):v}),a=v=>Number.isNaN(v)?!1:es(t.value)?t.value.validate(v):!0,l=v=>{a(v)&&(t.value.value=v)};return ue(r,()=>{s.value=!1}),{editMode:o,invalid:s,tempValue:r,inputEl:n,stringRepresentation:i,validate:a,setValue:l,enterEditMode:async()=>{r.value=t.value.value.toFixed(e),o.value=!0,await ot(),n.value&&n.value.focus()},leaveEditMode:()=>{const v=parseFloat(r.value);a(v)?(l(v),o.value=!1):s.value=!0}}},ts={},ns={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function os(t,e){return m(),_("svg",ns,e[0]||(e[0]=[C("polyline",{points:"6 9 12 15 18 9"},null,-1)]))}const Ae=D(ts,[["render",os]]),ss=L({components:{"i-arrow":Ae},props:{intf:{type:Object,required:!0}},setup(t){const e=ft(me(t,"intf"),0);return{...e,increment:()=>{e.setValue(t.intf.value+1)},decrement:()=>{e.setValue(t.intf.value-1)}}}}),is={class:"baklava-num-input"},as=["title"],rs={class:"__value"},ls={key:1,class:"__content"};function us(t,e,n,o,s,r){const i=ge("i-arrow");return m(),_("div",is,[C("div",{class:"__button --dec",onClick:e[0]||(e[0]=(...a)=>t.decrement&&t.decrement(...a))},[V(i)]),t.editMode?(m(),_("div",ls,[ve(C("input",{ref:"inputEl","onUpdate:modelValue":e[2]||(e[2]=a=>t.tempValue=a),type:"number",class:X(["baklava-input",{"--invalid":t.invalid}]),style:{"text-align":"right"},onBlur:e[3]||(e[3]=(...a)=>t.leaveEditMode&&t.leaveEditMode(...a)),onKeydown:e[4]||(e[4]=Te((...a)=>t.leaveEditMode&&t.leaveEditMode(...a),["enter"]))},null,34),[[ke,t.tempValue]])])):(m(),_("div",{key:0,class:"__content",onClick:e[1]||(e[1]=(...a)=>t.enterEditMode&&t.enterEditMode(...a))},[C("div",{class:"__label",title:t.intf.name},U(t.intf.name),9,as),C("div",rs,U(t.stringRepresentation),1)])),C("div",{class:"__button --inc",onClick:e[5]||(e[5]=(...a)=>t.increment&&t.increment(...a))},[V(i)])])}const sn=D(ss,[["render",us]]);class ds extends vt{constructor(){super(...arguments),this.component=de(sn)}validate(e){return Number.isInteger(e)&&super.validate(e)}}const cs={class:"baklava-num-input"},ps=["title"],hs={class:"__value"},vs={key:1,class:"__content"},an=L({__name:"NumberInterface",props:{intf:{}},setup(t){const e=t,{editMode:n,invalid:o,tempValue:s,inputEl:r,stringRepresentation:i,enterEditMode:a,leaveEditMode:l,setValue:u}=ft(me(e,"intf"));function h(){const p=parseFloat((e.intf.value+.1).toFixed(3));u(p)}function v(){const p=parseFloat((e.intf.value-.1).toFixed(3));u(p)}return(p,c)=>(m(),_("div",cs,[C("div",{class:"__button --dec",onClick:v},[V(Ae)]),A(n)?(m(),_("div",vs,[ve(C("input",{ref_key:"inputEl",ref:r,"onUpdate:modelValue":c[1]||(c[1]=d=>Ot(s)?s.value=d:null),type:"number",class:X(["baklava-input",{"--invalid":A(o)}]),style:{"text-align":"right"},onBlur:c[2]||(c[2]=(...d)=>A(l)&&A(l)(...d)),onKeydown:c[3]||(c[3]=Te((...d)=>A(l)&&A(l)(...d),["enter"]))},null,34),[[ke,A(s)]])])):(m(),_("div",{key:0,class:"__content",onClick:c[0]||(c[0]=(...d)=>A(a)&&A(a)(...d))},[C("div",{class:"__label",title:p.intf.name},U(p.intf.name),9,ps),C("div",hs,U(A(i)),1)])),C("div",{class:"__button --inc",onClick:h},[V(Ae)])]))}});class fs extends vt{constructor(){super(...arguments),this.component=de(an)}}const ms=L({components:{"i-arrow":Ae},props:{intf:{type:Object,required:!0}},setup(t){const e=E(null),n=E(!1),o=N(()=>t.intf.items.find(i=>typeof i=="string"?i===t.intf.value:i.value===t.intf.value)),s=N(()=>o.value?typeof o.value=="string"?o.value:o.value.text:""),r=i=>{t.intf.value=typeof i=="string"?i:i.value};return Wt(e,()=>{n.value=!1}),{el:e,open:n,selectedItem:o,selectedText:s,setSelected:r}}}),gs=["title"],ys={class:"__selected"},bs={class:"__text"},ws={class:"__icon"},_s={class:"__dropdown"},Cs={class:"item --header"},xs=["onClick"];function ks(t,e,n,o,s,r){const i=ge("i-arrow");return m(),_("div",{ref:"el",class:X(["baklava-select",{"--open":t.open}]),title:t.intf.name,onClick:e[0]||(e[0]=a=>t.open=!t.open)},[C("div",ys,[C("div",bs,U(t.selectedText),1),C("div",ws,[V(i)])]),V(st,{name:"slide-fade"},{default:Ve(()=>[ve(C("div",_s,[C("div",Cs,U(t.intf.name),1),(m(!0),_(q,null,ne(t.intf.items,(a,l)=>(m(),_("div",{key:l,class:X(["item",{"--active":a===t.selectedItem}]),onClick:u=>t.setSelected(a)},U(typeof a=="string"?a:a.text),11,xs))),128))],512),[[Rt,t.open]])]),_:1})],10,gs)}const rn=D(ms,[["render",ks]]);class Is extends W{constructor(e,n,o){super(e,n),this.component=de(rn),this.items=o}}const Ms=L({props:{intf:{type:Object,required:!0}},setup(t){const e=E(null),n=ft(me(t,"intf")),o=E(!1),s=E(!1),r=N(()=>Math.min(100,Math.max(0,(t.intf.value-t.intf.min)*100/(t.intf.max-t.intf.min))));return{...n,el:e,percentage:r,mousedown:()=>{n.editMode.value||(s.value=!0)},mouseup:()=>{n.editMode.value||(o.value||n.enterEditMode(),s.value=!1,o.value=!1)},mousemove:h=>{if(n.editMode.value)return;const v=Math.max(t.intf.min,Math.min(t.intf.max,(t.intf.max-t.intf.min)*(h.offsetX/e.value.clientWidth)+t.intf.min));s.value&&(n.setValue(v),o.value=!0)},mouseleave:h=>{n.editMode.value||(s.value&&(h.offsetX>=e.value.clientWidth?n.setValue(t.intf.max):h.offsetX<=0&&n.setValue(t.intf.min)),s.value=!1,o.value=!1)}}}}),Ns={key:0,class:"__content"},Es={class:"__label"},Ts={class:"__value"},$s={key:1,class:"__content"};function Ss(t,e,n,o,s,r){return m(),_("div",{ref:"el",class:X(["baklava-slider",{"baklava-ignore-mouse":!t.editMode}]),onPointerdown:e[3]||(e[3]=(...i)=>t.mousedown&&t.mousedown(...i)),onPointerup:e[4]||(e[4]=(...i)=>t.mouseup&&t.mouseup(...i)),onPointermove:e[5]||(e[5]=(...i)=>t.mousemove&&t.mousemove(...i)),onPointerleave:e[6]||(e[6]=(...i)=>t.mouseleave&&t.mouseleave(...i))},[C("div",{class:"__slider",style:he({width:t.percentage+"%"})},null,4),t.editMode?(m(),_("div",$s,[ve(C("input",{ref:"inputEl","onUpdate:modelValue":e[0]||(e[0]=i=>t.tempValue=i),type:"number",class:X(["baklava-input",{"--invalid":t.invalid}]),style:{"text-align":"right"},onBlur:e[1]||(e[1]=(...i)=>t.leaveEditMode&&t.leaveEditMode(...i)),onKeydown:e[2]||(e[2]=Te((...i)=>t.leaveEditMode&&t.leaveEditMode(...i),["enter"]))},null,34),[[ke,t.tempValue]])])):(m(),_("div",Ns,[C("div",Es,U(t.intf.name),1),C("div",Ts,U(t.stringRepresentation),1)]))],34)}const ln=D(Ms,[["render",Ss]]);class Os extends vt{constructor(e,n,o,s){super(e,n,o,s),this.component=de(ln),this.min=o,this.max=s}}const As=L({props:{intf:{type:Object,required:!0}}});function Ps(t,e,n,o,s,r){return m(),_("div",null,U(t.intf.value),1)}const Rs=D(As,[["render",Ps]]);class Ds extends W{constructor(e,n){super(e,n),this.component=de(Rs),this.setPort(!1)}}const Bs=L({props:{intf:{type:Object,required:!0},modelValue:{type:String,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){return{v:N({get:()=>t.modelValue,set:o=>{e("update:modelValue",o)}})}}}),Hs=["placeholder","title"];function Ls(t,e,n,o,s,r){return m(),_("div",null,[ve(C("input",{"onUpdate:modelValue":e[0]||(e[0]=i=>t.v=i),type:"text",class:"baklava-input",placeholder:t.intf.name,title:t.intf.name},null,8,Hs),[[ke,t.v]])])}const un=D(Bs,[["render",Ls]]);class mt extends W{constructor(){super(...arguments),this.component=de(un)}}const Us=L({props:{intf:{type:Object,required:!0},modelValue:{type:String,required:!0}},emits:["update:modelValue"],setup(t,{emit:e}){return{v:N({get:()=>t.modelValue,set:o=>{e("update:modelValue",o)}})}}}),Vs=["placeholder","title"];function zs(t,e,n,o,s,r){return m(),_("div",null,[ve(C("textarea",{"onUpdate:modelValue":e[0]||(e[0]=i=>t.v=i),rows:"5",class:"baklava-input",placeholder:t.intf.name,title:t.intf.name},null,8,Vs),[[ke,t.v]])])}const dn=D(Us,[["render",zs]]);class Gs extends W{constructor(){super(...arguments),this.component=de(dn)}}const G=[];for(let t=0;t<256;++t)G.push((t+256).toString(16).slice(1));function js(t,e=0){return(G[t[e+0]]+G[t[e+1]]+G[t[e+2]]+G[t[e+3]]+"-"+G[t[e+4]]+G[t[e+5]]+"-"+G[t[e+6]]+G[t[e+7]]+"-"+G[t[e+8]]+G[t[e+9]]+"-"+G[t[e+10]]+G[t[e+11]]+G[t[e+12]]+G[t[e+13]]+G[t[e+14]]+G[t[e+15]]).toLowerCase()}let Je;const Ws=new Uint8Array(16);function Fs(){if(!Je){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Je=crypto.getRandomValues.bind(crypto)}return Je(Ws)}const Xs=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Et={randomUUID:Xs};function Pe(t,e,n){var o;if(Et.randomUUID&&!t)return Et.randomUUID();t=t||{};const s=t.random??((o=t.rng)==null?void 0:o.call(t))??Fs();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,js(s)}const xe="SAVE_SUBGRAPH";function Ys(t,e){const n=()=>{const o=t.value;if(!o.template)throw new Error("Graph template property not set");o.template.update(o.save()),o.template.panning=o.panning,o.template.scaling=o.scaling};e.registerCommand(xe,{canExecute:()=>{var o;return t.value!==((o=t.value.editor)==null?void 0:o.graph)},execute:n})}class cn extends at{constructor(){super(...arguments),this._title="Subgraph Input",this.inputs={name:new mt("Name","Input").setPort(!1)},this.outputs={placeholder:new W("Connection",void 0)}}}class pn extends rt{constructor(){super(...arguments),this._title="Subgraph Output",this.inputs={name:new mt("Name","Output").setPort(!1),placeholder:new W("Connection",void 0)},this.outputs={output:new W("Output",void 0).setHidden(!0)}}}const gt="CREATE_SUBGRAPH",Tt=[we,_e];function qs(t,e,n){const o=()=>t.value.selectedNodes.filter(r=>!Tt.includes(r.type)).length>0,s=()=>{const{viewModel:r}=J(),i=t.value,a=t.value.editor;if(i.selectedNodes.length===0)return;const l=i.selectedNodes.filter(w=>!Tt.includes(w.type)),u=l.flatMap(w=>Object.values(w.inputs)),h=l.flatMap(w=>Object.values(w.outputs)),v=i.connections.filter(w=>!h.includes(w.from)&&u.includes(w.to)),p=i.connections.filter(w=>h.includes(w.from)&&!u.includes(w.to)),c=i.connections.filter(w=>h.includes(w.from)&&u.includes(w.to)),d=l.map(w=>w.save()),b=c.map(w=>({id:w.id,from:w.from.id,to:w.to.id})),f=new Map,{xLeft:g,xRight:y,yTop:I}=Ks(l);for(const[w,T]of v.entries()){const B=new cn;B.inputs.name.value=T.to.name,d.push({...B.save(),position:{x:y-r.value.settings.nodes.defaultWidth-100,y:I+w*200}}),b.push({id:Pe(),from:B.outputs.placeholder.id,to:T.to.id}),f.set(T.to.id,B.graphInterfaceId)}for(const[w,T]of p.entries()){const B=new pn;B.inputs.name.value=T.from.name,d.push({...B.save(),position:{x:g+100,y:I+w*200}}),b.push({id:Pe(),from:T.from.id,to:B.inputs.placeholder.id}),f.set(T.from.id,B.graphInterfaceId)}const S=ae(new We({connections:b,nodes:d,inputs:[],outputs:[]},a));a.addGraphTemplate(S);const $=a.nodeTypes.get(Ce(S));if(!$)throw new Error("Unable to create subgraph: Could not find corresponding graph node type");i.activeTransactions++;const k=ae(new $.type);i.addNode(k);const O=Math.round(l.map(w=>w.position.x).reduce((w,T)=>w+T,0)/l.length),M=Math.round(l.map(w=>w.position.y).reduce((w,T)=>w+T,0)/l.length);k.position.x=O,k.position.y=M,v.forEach(w=>{i.removeConnection(w),i.addConnection(w.from,k.inputs[f.get(w.to.id)])}),p.forEach(w=>{i.removeConnection(w),i.addConnection(k.outputs[f.get(w.from.id)],w.to)}),l.forEach(w=>i.removeNode(w)),i.activeTransactions--,e.canExecuteCommand(xe)&&e.executeCommand(xe),n(S),t.value.panning={...i.panning},t.value.scaling=i.scaling};e.registerCommand(gt,{canExecute:o,execute:s})}function Ks(t){const e=t.reduce((s,r)=>{const i=r.position.x;return i<s?i:s},1/0),n=t.reduce((s,r)=>{const i=r.position.y;return i<s?i:s},1/0);return{xLeft:t.reduce((s,r)=>{const i=r.position.x+r.width;return i>s?i:s},-1/0),xRight:e,yTop:n}}class $t{constructor(e,n){this.type=e,e==="addNode"?this.nodeId=n:this.nodeState=n}undo(e){this.type==="addNode"?this.removeNode(e):this.addNode(e)}redo(e){this.type==="addNode"&&this.nodeState?this.addNode(e):this.type==="removeNode"&&this.nodeId&&this.removeNode(e)}addNode(e){const n=e.editor.nodeTypes.get(this.nodeState.type);if(!n)return;const o=new n.type;e.addNode(o),o.load(this.nodeState),this.nodeId=o.id}removeNode(e){const n=e.nodes.find(o=>o.id===this.nodeId);n&&(this.nodeState=n.save(),e.removeNode(n))}}class St{constructor(e,n){if(this.type=e,e==="addConnection")this.connectionId=n;else{const o=n;this.connectionState={id:o.id,from:o.from.id,to:o.to.id}}}undo(e){this.type==="addConnection"?this.removeConnection(e):this.addConnection(e)}redo(e){this.type==="addConnection"&&this.connectionState?this.addConnection(e):this.type==="removeConnection"&&this.connectionId&&this.removeConnection(e)}addConnection(e){const n=e.findNodeInterface(this.connectionState.from),o=e.findNodeInterface(this.connectionState.to);if(!n||!o)return;const s=e.addConnection(n,o);s&&(s.id=this.connectionState.id),this.connectionId=s?.id}removeConnection(e){const n=e.connections.find(o=>o.id===this.connectionId);n&&(this.connectionState={id:n.id,from:n.from.id,to:n.to.id},e.removeConnection(n))}}class Zs{constructor(e){if(this.type="transaction",e.length===0)throw new Error("Can't create a transaction with no steps");this.steps=e}undo(e){for(let n=this.steps.length-1;n>=0;n--)this.steps[n].undo(e)}redo(e){for(let n=0;n<this.steps.length;n++)this.steps[n].redo(e)}}const Re="UNDO",De="REDO",Xe="START_TRANSACTION",Ye="COMMIT_TRANSACTION",hn="CLEAR_HISTORY";function Js(t,e){const n=Symbol("HistoryToken"),o=E(200),s=E([]),r=E(!1),i=E(-1),a=E(!1),l=E([]),u=g=>{if(!r.value)if(a.value)l.value.push(g);else{for(i.value!==s.value.length-1&&(s.value=s.value.slice(0,i.value+1)),s.value.push(g);s.value.length>o.value;)s.value.shift();i.value=s.value.length-1}},h=()=>{a.value=!0},v=()=>{a.value=!1,l.value.length>0&&(u(new Zs(l.value)),l.value=[])},p=()=>s.value.length!==0&&i.value!==-1,c=()=>{p()&&(r.value=!0,s.value[i.value--].undo(t.value),r.value=!1)},d=()=>s.value.length!==0&&i.value<s.value.length-1,b=()=>{d()&&(r.value=!0,s.value[++i.value].redo(t.value),r.value=!1)},f=()=>{s.value=[],i.value=-1};return ue(t,(g,y)=>{y&&(y.events.addNode.unsubscribe(n),y.events.removeNode.unsubscribe(n),y.events.addConnection.unsubscribe(n),y.events.removeConnection.unsubscribe(n)),g&&(g.events.addNode.subscribe(n,I=>{u(new $t("addNode",I.id))}),g.events.removeNode.subscribe(n,I=>{u(new $t("removeNode",I.save()))}),g.events.addConnection.subscribe(n,I=>{u(new St("addConnection",I.id))}),g.events.removeConnection.subscribe(n,I=>{u(new St("removeConnection",I))}))},{immediate:!0}),e.registerCommand(Re,{canExecute:p,execute:c}),e.registerCommand(De,{canExecute:d,execute:b}),e.registerCommand(Xe,{canExecute:()=>!a.value,execute:h}),e.registerCommand(Ye,{canExecute:()=>a.value,execute:v}),e.registerCommand(hn,{canExecute:()=>s.value.length>0,execute:f}),e.registerHotkey(["Control","z"],Re),e.registerHotkey(["Control","y"],De),ae({maxSteps:o})}const Be="DELETE_NODES";function Qs(t,e){e.registerCommand(Be,{canExecute:()=>t.value.selectedNodes.length>0,execute(){e.executeCommand(Xe);for(let n=t.value.selectedNodes.length-1;n>=0;n--){const o=t.value.selectedNodes[n];t.value.removeNode(o)}e.executeCommand(Ye)}}),e.registerHotkey(["Delete"],Be)}const yt="SWITCH_TO_MAIN_GRAPH";function ei(t,e,n){e.registerCommand(yt,{canExecute:()=>t.value!==t.value.editor.graph,execute:()=>{e.executeCommand(xe),n(t.value.editor.graph)}})}function ti(t,e,n){Qs(t,e),qs(t,e,n),Ys(t,e),ei(t,e,n)}const He="COPY",Le="PASTE",vn="CLEAR_CLIPBOARD";function ni(t,e,n){const o=Symbol("ClipboardToken"),s=E(""),r=E(""),i=N(()=>!s.value),a=()=>{s.value="",r.value=""},l=()=>{const v=t.value.selectedNodes.flatMap(c=>[...Object.values(c.inputs),...Object.values(c.outputs)]),p=t.value.connections.filter(c=>v.includes(c.from)||v.includes(c.to)).map(c=>({from:c.from.id,to:c.to.id}));r.value=JSON.stringify(p),s.value=JSON.stringify(t.value.selectedNodes.map(c=>c.save()))},u=(v,p,c)=>{for(const d of v){let b;if((!c||c==="input")&&(b=Object.values(d.inputs).find(f=>f.id===p)),!b&&(!c||c==="output")&&(b=Object.values(d.outputs).find(f=>f.id===p)),b)return b}},h=()=>{if(i.value)return;const v=new Map,p=JSON.parse(s.value),c=JSON.parse(r.value),d=[],b=[],f=t.value;n.executeCommand(Xe);for(const g of p){const y=e.value.nodeTypes.get(g.type);if(!y){console.warn(`Node type ${g.type} not registered`);return}const I=new y.type,S=I.id;d.push(I),I.hooks.beforeLoad.subscribe(o,$=>{const k=$;return k.position&&(k.position.x+=100,k.position.y+=100),I.hooks.beforeLoad.unsubscribe(o),k}),f.addNode(I),I.load({...g,id:S}),I.id=S,v.set(g.id,S);for(const $ of Object.values(I.inputs)){const k=Pe();v.set($.id,k),$.id=k}for(const $ of Object.values(I.outputs)){const k=Pe();v.set($.id,k),$.id=k}}for(const g of c){const y=u(d,v.get(g.from),"output"),I=u(d,v.get(g.to),"input");if(!y||!I)continue;const S=f.addConnection(y,I);S&&b.push(S)}return t.value.selectedNodes=d,n.executeCommand(Ye),{newNodes:d,newConnections:b}};return n.registerCommand(He,{canExecute:()=>t.value.selectedNodes.length>0,execute:l}),n.registerHotkey(["Control","c"],He),n.registerCommand(Le,{canExecute:()=>!i.value,execute:h}),n.registerHotkey(["Control","v"],Le),n.registerCommand(vn,{canExecute:()=>!0,execute:a}),ae({isEmpty:i})}const fn="OPEN_SIDEBAR";function oi(t,e){e.registerCommand(fn,{execute:n=>{t.value.sidebar.nodeId=n,t.value.sidebar.visible=!0},canExecute:()=>!0})}const si=(t,e)=>{t.displayInSidebar=e};function ii(t,e){oi(t,e)}const mn="ZOOM_TO_FIT_RECT",gn="ZOOM_TO_FIT_NODES",Ue="ZOOM_TO_FIT_GRAPH";function ai(t,e,n){e.registerCommand(mn,{canExecute:()=>!0,execute:o=>yn(t.value,n,o)}),e.registerCommand(gn,{canExecute:()=>!0,execute:o=>bn(t.value,n,o)}),e.registerCommand(Ue,{canExecute:()=>t.value.nodes.length>0,execute:()=>ri(t.value,n)}),e.registerHotkey(["f"],Ue)}function yn(t,e,n){const o={left:e.zoomToFit.paddingLeft,right:e.zoomToFit.paddingRight,top:e.zoomToFit.paddingTop,bottom:e.zoomToFit.paddingBottom},r=document.querySelector(".baklava-editor").getBoundingClientRect(),i=Math.max(0,r.width-o.left-o.right),a=Math.max(0,r.height-o.top-o.bottom);n=ui(n);const l=n.x2-n.x1,u=n.y2-n.y1,h=l===0?1/0:i/l,v=u==0?1/0:a/u;let p=Math.min(h,v);(p===0||!Number.isFinite(p))&&(p=1);const c=Math.max(0,i/p-l),d=Math.max(0,a/p-u),b=-n.x1+o.left/p+c/2,f=-n.y1+o.top/p+d/2;t.panning.x=b,t.panning.y=f,t.scaling=p}function bn(t,e,n){if(n.length===0)return;const o=n.map(li),s={x1:Math.min(...o.map(r=>r.x1)),y1:Math.min(...o.map(r=>r.y1)),x2:Math.max(...o.map(r=>r.x2)),y2:Math.max(...o.map(r=>r.y2))};yn(t,e,s)}function ri(t,e){bn(t,e,t.nodes)}function li(t){var e,n;const o=document.getElementById(t.id),s=o?.offsetWidth??0,r=o?.offsetHeight??0,i=((e=t.position)==null?void 0:e.x)??0,a=((n=t.position)==null?void 0:n.y)??0;return{x1:i,y1:a,x2:i+s,y2:a+r}}function ui(t){return{x1:Math.min(t.x1,t.x2),y1:Math.min(t.y1,t.y2),x2:Math.max(t.x1,t.x2),y2:Math.max(t.y1,t.y2)}}const di=Object.freeze(Object.defineProperty({__proto__:null,CLEAR_CLIPBOARD_COMMAND:vn,CLEAR_HISTORY_COMMAND:hn,COMMIT_TRANSACTION_COMMAND:Ye,COPY_COMMAND:He,CREATE_SUBGRAPH_COMMAND:gt,DELETE_NODES_COMMAND:Be,OPEN_SIDEBAR_COMMAND:fn,PASTE_COMMAND:Le,REDO_COMMAND:De,SAVE_SUBGRAPH_COMMAND:xe,START_SELECTION_BOX_COMMAND:Ne,START_TRANSACTION_COMMAND:Xe,SWITCH_TO_MAIN_GRAPH_COMMAND:yt,UNDO_COMMAND:Re,ZOOM_TO_FIT_GRAPH_COMMAND:Ue,ZOOM_TO_FIT_NODES_COMMAND:gn,ZOOM_TO_FIT_RECT_COMMAND:mn},Symbol.toStringTag,{value:"Module"})),ci={},pi={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function hi(t,e){return m(),_("svg",pi,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("path",{d:"M9 13l-4 -4l4 -4m-4 4h11a4 4 0 0 1 0 8h-1"},null,-1)]))}const vi=D(ci,[["render",hi]]),fi={},mi={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function gi(t,e){return m(),_("svg",mi,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("path",{d:"M15 13l4 -4l-4 -4m4 4h-11a4 4 0 0 0 0 8h1"},null,-1)]))}const yi=D(fi,[["render",gi]]),bi={},wi={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function _i(t,e){return m(),_("svg",wi,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("line",{x1:"5",y1:"12",x2:"19",y2:"12"},null,-1),C("line",{x1:"5",y1:"12",x2:"11",y2:"18"},null,-1),C("line",{x1:"5",y1:"12",x2:"11",y2:"6"},null,-1)]))}const Ci=D(bi,[["render",_i]]),xi={},ki={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Ii(t,e){return m(),_("svg",ki,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("path",{d:"M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"},null,-1),C("rect",{x:"9",y:"3",width:"6",height:"4",rx:"2"},null,-1)]))}const Mi=D(xi,[["render",Ii]]),Ni={},Ei={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Ti(t,e){return m(),_("svg",Ei,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("rect",{x:"8",y:"8",width:"12",height:"12",rx:"2"},null,-1),C("path",{d:"M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"},null,-1)]))}const $i=D(Ni,[["render",Ti]]),Si={},Oi={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Ai(t,e){return m(),_("svg",Oi,e[0]||(e[0]=[C("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"},null,-1),C("path",{d:"M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2"},null,-1),C("circle",{cx:"12",cy:"14",r:"2"},null,-1),C("polyline",{points:"14 4 14 8 8 8 8 4"},null,-1)]))}const Pi=D(Si,[["render",Ai]]),Ri={},Di={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Bi(t,e){return m(),_("svg",Di,e[0]||(e[0]=[Ge('<path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M10 3h4v4h-4z"></path><path d="M3 17h4v4h-4z"></path><path d="M17 17h4v4h-4z"></path><path d="M7 17l5 -4l5 4"></path><line x1="12" y1="7" x2="12" y2="13"></line>',6)]))}const Hi=D(Ri,[["render",Bi]]),Li={},Ui={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Vi(t,e){return m(),_("svg",Ui,e[0]||(e[0]=[Ge('<path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M8 8m0 1a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-6a1 1 0 0 1 -1 -1z"></path><path d="M12 20v.01"></path><path d="M16 20v.01"></path><path d="M8 20v.01"></path><path d="M4 20v.01"></path><path d="M4 16v.01"></path><path d="M4 12v.01"></path><path d="M4 8v.01"></path><path d="M4 4v.01"></path><path d="M8 4v.01"></path><path d="M12 4v.01"></path><path d="M16 4v.01"></path><path d="M20 4v.01"></path><path d="M20 8v.01"></path><path d="M20 12v.01"></path><path d="M20 16v.01"></path><path d="M20 20v.01"></path>',18)]))}const zi=D(Li,[["render",Vi]]),Gi={},ji={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function Wi(t,e){return m(),_("svg",ji,e[0]||(e[0]=[Ge('<path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>',6)]))}const Fi=D(Gi,[["render",Wi]]),Xi={},Yi={xmlns:"http://www.w3.org/2000/svg",class:"baklava-icon",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"};function qi(t,e){return m(),_("svg",Yi,e[0]||(e[0]=[Ge('<path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path><path d="M4 16v2a2 2 0 0 0 2 2h2"></path><path d="M16 4h2a2 2 0 0 1 2 2v2"></path><path d="M16 20h2a2 2 0 0 0 2 -2v-2"></path><path d="M8 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path><path d="M16 16l-2.5 -2.5"></path>',7)]))}const Ki=D(Xi,[["render",qi]]),wn={COPY:{command:He,title:"Copy",icon:$i},PASTE:{command:Le,title:"Paste",icon:Mi},DELETE_NODES:{command:Be,title:"Delete selected nodes",icon:Fi},UNDO:{command:Re,title:"Undo",icon:vi},REDO:{command:De,title:"Redo",icon:yi},ZOOM_TO_FIT_GRAPH:{command:Ue,title:"Zoom to Fit",icon:Ki},START_SELECTION_BOX:{command:Ne,title:"Box Select",icon:zi},CREATE_SUBGRAPH:{command:gt,title:"Create Subgraph",icon:Hi}},_n=Object.values(wn),Cn={SAVE_SUBGRAPH:{command:xe,title:"Save Subgraph",icon:Pi},SWITCH_TO_MAIN_GRAPH:{command:yt,title:"Back to Main Graph",icon:Ci}},xn=Object.values(Cn),Zi=t=>!(t instanceof je);function Ji(t,e){return{switchGraph:o=>{let s;if(Zi(o))s=new je(t.value),o.createGraph(s);else{if(o!==t.value.graph)throw new Error("Can only switch using 'Graph' instance when it is the root graph. Otherwise a 'GraphTemplate' must be used.");s=o}e.value&&e.value!==t.value.graph&&e.value.destroy(),s.panning=s.panning??o.panning??{x:0,y:0},s.scaling=s.scaling??o.scaling??1,s.selectedNodes=s.selectedNodes??[],s.sidebar=s.sidebar??{visible:!1,nodeId:"",optionName:""},e.value=s}}}function Qi(t,e){t.position=t.position??{x:0,y:0},t.disablePointerEvents=!1,t.twoColumn=t.twoColumn??!1,t.width=t.width??e.defaultWidth}const ea=()=>({useStraightConnections:!1,enableMinimap:!1,toolbar:{enabled:!0,commands:_n,subgraphCommands:xn},palette:{enabled:!0},background:{gridSize:100,gridDivision:5,subGridVisibleThreshold:.6},sidebar:{enabled:!0,width:300,resizable:!0},displayValueOnHover:!1,nodes:{defaultWidth:200,maxWidth:320,minWidth:150,resizable:!1,reverseY:!1},contextMenu:{enabled:!0,additionalItems:[]},zoomToFit:{paddingLeft:300,paddingRight:50,paddingTop:110,paddingBottom:50}});function ta(t){const e=E(t??new zn),n=Symbol("ViewModelToken"),o=E(null),s=In(o),{switchGraph:r}=Ji(e,o),i=N(()=>s.value&&s.value!==e.value.graph),a=ae(ea()),l=tn(),u=Js(s,l),h=ni(s,e,l),v={renderNode:new te(null),renderInterface:new te(null)};return ti(s,l,r),ii(s,l),ai(s,l,a),ue(e,(p,c)=>{c&&(c.events.registerGraph.unsubscribe(n),c.graphEvents.beforeAddNode.unsubscribe(n),p.nodeHooks.beforeLoad.unsubscribe(n),p.nodeHooks.afterSave.unsubscribe(n),p.graphTemplateHooks.beforeLoad.unsubscribe(n),p.graphTemplateHooks.afterSave.unsubscribe(n),p.graph.hooks.load.unsubscribe(n),p.graph.hooks.save.unsubscribe(n)),p&&(p.nodeHooks.beforeLoad.subscribe(n,(d,b)=>(b.position=d.position??{x:0,y:0},b.width=d.width??a.nodes.defaultWidth,b.twoColumn=d.twoColumn??!1,d)),p.nodeHooks.afterSave.subscribe(n,(d,b)=>(d.position=b.position,d.width=b.width,d.twoColumn=b.twoColumn,d)),p.graphTemplateHooks.beforeLoad.subscribe(n,(d,b)=>(b.panning=d.panning,b.scaling=d.scaling,d)),p.graphTemplateHooks.afterSave.subscribe(n,(d,b)=>(d.panning=b.panning,d.scaling=b.scaling,d)),p.graph.hooks.load.subscribe(n,(d,b)=>(b.panning=d.panning,b.scaling=d.scaling,d)),p.graph.hooks.save.subscribe(n,(d,b)=>(d.panning=b.panning,d.scaling=b.scaling,d)),p.graphEvents.beforeAddNode.subscribe(n,d=>Qi(d,{defaultWidth:a.nodes.defaultWidth})),e.value.registerNodeType(cn,{category:"Subgraphs"}),e.value.registerNodeType(pn,{category:"Subgraphs"}),r(p.graph))},{immediate:!0}),ae({editor:e,displayedGraph:s,isSubgraph:i,settings:a,commandHandler:l,history:u,clipboard:h,hooks:v,switchGraph:r})}const na=Object.freeze(Object.defineProperty({__proto__:null,Connection:ht,ConnectionWrapper:Kt,ContextMenu:Fe,Minimap:Qt,Node:Yt,NodeInterface:tt,NodePalette:en,Sidebar:Jt,TemporaryConnection:Zt},Symbol.toStringTag,{value:"Module"})),ia=Object.freeze(Object.defineProperty({__proto__:null,BaklavaEditor:Mt,ButtonInterface:Ko,ButtonInterfaceComponent:nn,CheckboxInterface:Qo,CheckboxInterfaceComponent:on,Commands:di,Components:na,DEFAULT_TOOLBAR_COMMANDS:_n,DEFAULT_TOOLBAR_SUBGRAPH_COMMANDS:xn,EditorComponent:Mt,IntegerInterface:ds,IntegerInterfaceComponent:sn,NumberInterface:fs,NumberInterfaceComponent:an,SelectInterface:Is,SelectInterfaceComponent:rn,SliderInterface:Os,SliderInterfaceComponent:ln,TOOLBAR_COMMANDS:wn,TOOLBAR_SUBGRAPH_COMMANDS:Cn,TemporaryConnectionState:Q,TextInputInterface:mt,TextInputInterfaceComponent:un,TextInterface:Ds,TextareaInputInterface:Gs,TextareaInputInterfaceComponent:dn,displayInSidebar:si,getDomElementOfNode:qt,getDomElements:ye,getNodePosition:jn,getPortCoordinates:Se,isInputElement:lt,providePlugin:Lt,provideTemporaryConnection:zt,setNodePosition:Wn,useBaklava:ta,useCommandHandler:tn,useDragMove:ut,useGraph:ee,useNodeCategories:dt,useTemporaryConnection:Gt,useTransform:ct,useViewModel:J},Symbol.toStringTag,{value:"Module"}));export{ta as $,Bt as A,H as B,Ct as C,Dn as D,zn as E,Q as F,je as G,mt as H,ds as I,un as J,Ds as K,Gs as L,dn as M,Ln as N,si as O,Y as P,qt as Q,ye as R,te as S,wn as T,jn as U,Se as V,lt as W,Lt as X,zt as Y,Wn as Z,Mt as _,Hn as a,tn as a0,ut as a1,ee as a2,dt as a3,Gt as a4,ct as a5,J as a6,ia as a7,we as b,_e as c,at as d,rt as e,$e as f,Ce as g,Vn as h,We as i,W as j,Ko as k,nn as l,Qo as m,on as n,di as o,na as p,_n as q,xn as r,sn as s,fs as t,an as u,Is as v,rn as w,Os as x,ln as y,Cn as z};
